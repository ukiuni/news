---
layout: post
title: "Running Lean at Scale - スケールで「リーン」に動かす"
date: 2026-01-13T23:17:44.969Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://harmonic.fun/news#blog-post-lean"
source_title: "Harmonic - News"
source_id: 46608731
excerpt: "Protobuf高速化と形式検証AIで大規模Python処理を劇的に改善する実践ガイド"
image: "https://harmonic.fun/harmonic-icon-512x512.png"
---

# Running Lean at Scale - スケールで「リーン」に動かす
魅力的なインフラ刷新で「遅い・重い・扱いにくい」を吹き飛ばす──プロダクションで使える高速Protobufと形式検証AIの衝撃

## 要約
Harmonicの技術チームは、大規模データ処理での「遅さ・メモリ不足・Pythonの使い勝手」を解決するため、AOTでC++拡張を生成する軽量Protobufコンパイラ pbcc を実装・公開した。また、同社の数学推論モデル Aristotle は、VERINA ベンチマークで96.8%の証明/反例検出性能を達成している。

## この記事を読むべき理由
- Pythonで大きなバイナリ/メッセージを扱う現場は増加中。標準Protobufがボトルネックになるケースが日本のSaaS/データ系プロダクトでも多発しているため、実務に直結する解決案が参考になる。  
- 形式検証（仕様と実装の一致を自動で証明・反例発見）により、ソフトウェアの信頼性向上が期待できる。日本の金融・組み込み・研究用途でも応用余地が大きい。

## 詳細解説
- 問題意識：標準のPython向けProtobufは、巨大メッセージで遅く、2GB以上の入力で失敗するなどの制限があり、またラッパー型（カスタムコンテナ）によってIDEの補完や型チェックが効きにくいという実務上の不満があった。
- pbcc の設計：
  - AOT（ahead-of-time）方式を採用。既存の .proto から生成されたメッセージ記述を読み、テンプレート化したC++ソース（pymodule.in.cc）を具体化してネイティブ拡張（.so）を作成する。
  - 生成モジュールはPythonのクラス（dataclassに似た振る舞い）として振る舞い、直列化/逆直列化を高速に行う。
  - APIは「Pythonic」を重視：repeated → list、map → dict、optional → None といったネイティブ型で扱えるため、型ヒント（.pyiスタブ）を生成してIDE補完やmypy互換性を確保している。
- パフォーマンスと安全性：
  - メモリ管理は PyObjectRef のような参照管理ラッパでメモリリークを抑制。64ビット整数を全面採用し、2GB制限の回避を狙う設計。
  - StringReader / StringWriter のような独自バッファで不要コピーを減らす実装により、Googleの upb と同等クラスの高速性を達成している。
  - 正確性重視のテスト群を整備し、unknown field の保持／削除を明示できるなど仕様互換性も配慮している。
- Aristotle と VERINA：
  - Harmonicの数学推論モデル Aristotle は、VERINA（検証可能なコード生成ベンチマーク）で189件中160件を正と判定、23件を誤りとして検出し96.8%の解決率を報告。具体例として最長増加部分列や top-k 頻度問題の仕様誤りを証明／反例提示できる能力を示した。
  - これにより「自動生成コードの正しさを証明する」方向のプロダクト適用が現実味を帯びている。

## 実践ポイント
- 大規模バイナリを扱うPythonプロジェクトでは、標準protobufがボトルネックならAOTでネイティブ拡張を生成するアプローチ（pbccのような設計）を検討する価値が高い。特にメモリ使用量と型安全性を重視する場合に有効。  
- IDEでの型補完やmypy互換を保ちたい場合は、.pyi スタブの生成を導入すると開発体験が劇的に改善する。  
- 形式検証に興味があるチームは、VERINAやLeanなどのツールを試し、仕様と実装を機械的に検証するワークフローを一部導入してみると、バグの早期発見や設計ミスの検出につながる。  
- 実装を自前で作る判断は「必要性 × 維持コスト × 専門スキル」のバランスで決める。pbccは「既存が許容しない規模や使い勝手」の場合に有効なケーススタディとなる。  
- 実物を確認したければ公式リポジトリを参照（https://github.com/harmonic-ai/pbcc）。

短く言えば、スケール時の「遅い・重い・使いにくい」を技術的に解決する実践例と、生成コードの正しさを自動で検証する新しい潮流の両方が示された記事。日本の現場でもすぐに応用できる知見が多い。
