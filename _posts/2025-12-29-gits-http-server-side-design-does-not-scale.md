---
layout: post
title: "Git's HTTP server side design does not scale"
date: 2025-12-29T19:29:53.857Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://xeiaso.net/notes/2025/distributed-git-ddos"
source_title: "Making sure you&#39;re not a bot!"
source_id: 1316747096
excerpt: "公開GitをHTTPで提供すると同時クローンで負荷爆発、事前パック等で即座に緩和可能"
---

# GitのHTTPサーバは本当に「スケールしない」のか？ — 見えないDDoSの仕組みと現場対策

## 要約
GitのHTTP（smart/dumb HTTPいずれも）には、クライアントごとにサーバ側で重い処理を行わせる設計上の特性があり、多数の同時リクエストで容易にサーバ負荷が高まる。準備済みの対策がなければ、分散的なアクセス（意図的/非意図的問わず）が「見えないDDoS」を引き起こす可能性が高い。

## この記事を読むべき理由
社内Gitサーバやオープンソースのホスティングを運用する日本の開発組織・SREは、リポジトリ公開やCIでのクローン負荷を想定しておく必要がある。設計の実情を理解すると、低コストで即効性のある対策を講じられる。

## 詳細解説
- なぜ負荷が高くなるのか  
  Gitのクライアントは「どのオブジェクトが必要か」をサーバと交渉してからパック（packfile）を受け取る。smart HTTPでも、サーバはgit-upload-pack等を実行して要求に合わせた差分パックを作成・圧縮して返す。要するに「各クライアントの要求に応じてサーバ側で差分生成と圧縮という重い処理が発生する」設計になっている。

- キャッシュが効きにくい理由  
  negotiation（広告→want/haveのやり取り）で生成されるパックはクライアントごとに異なるため、通常のHTTPキャッシュ（CDNやリバースプロキシ）でうまくヒットしないことが多い。結果、単純な静的配信と比べてCPU/メモリ負荷が高い。

- 攻撃・過負荷シナリオ  
  多数のマシン（ボットネットやCIの同時実行）が並列にclone/fetchを行うと、サーバは短時間に大量の差分生成を強いられ、CPU・メモリ・I/Oが枯渇する。特に大きなリポジトリや頻繁に更新される公開リポジトリで顕著。

- プロトコル改良の余地  
  Gitプロトコルv2やサーバ側での事前パッキングは改善になるが、運用次第では依然として個別生成の問題は残る。さらに、リポジトリ設計（大きなバイナリ混入等）次第で悪化する。

## 実践ポイント
- まずは観測を強化する  
  クローン/フェッチのパターン、最頻リクエスト、ピーク時間帯をログ・メトリクスで把握する。CIやミラーのアクセスパターンを洗い出すことが対策の出発点。

- 事前にパックを作る（prebuilt packs）  
  人気のあるrefsや定期的にアクセスされる状態については、サーバ側であらかじめrepackして静的なpackfileを用意し、HTTPで静的配信できるようにする。これにより生成コストを大幅に削減できる。

- CDN / リバースプロキシの活用（注意点あり）  
  /objects/pack/*.pack のように一意なパスが安定しているコンテンツはキャッシュ可能。ネゴシエーションの結果が異なるAPIレスポンスは無理にキャッシュしない。VaryやCache-Controlを適切に設定する。

- Gitプロトコルv2・daemonの検討  
  可能なら新しいプロトコルやgit-daemonを併用するとオーバーヘッドを下げられるケースがある。ただしファイアウォールや運用要件との兼ね合いを検討する。

- レート制限と接続制御  
  nginx/Apacheで同時接続数やリクエストレートを制限する。CIや自動化ユーザーには専用のレート枠を用意するなどのポリシー運用も有効。

- 認証・アクセス制御とBOT対策  
  公開リポジトリであってもAgent識別やWAF/Cloudflare等のBot緩和を導入して、明らかに異常な大量接続をブロックする。

- リポジトリ設計の改善  
  大きな履歴やバイナリを分離（Git LFSや別リポジトリ）し、クローン時の転送量と処理負荷を下げる。

- ミラー・レプリカ運用  
  地理的に近いミラーや読み取り専用のレプリカを用意してアクセスを分散する。CI用にローカルキャッシュを使うのも有効。

- テストと演習  
  変更後は負荷試験で効果を確認する。ピーク想定より上のスケールで試験してボトルネックを洗い出す。

---

Gitの設計上の特性を理解すると、「なぜHTTPで手軽に公開すると危険になりやすいか」が見えるようになります。小さな運用改善（パック事前生成、キャッシュ有効化、レート制限）で実効的な防御が可能なので、まずは観測から始めてください。
