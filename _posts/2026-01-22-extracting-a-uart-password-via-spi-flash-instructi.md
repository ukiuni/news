---
layout: post
title: "Extracting a UART Password via SPI Flash Instruction Tracing - SPIフラッシュ命令トレースでUARTパスワードを抽出する"
date: 2026-01-22T23:58:23.182Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://zuernerd.github.io/blog/2026/01/07/switch-password.html"
source_title: "Extracting a UART Password via SPI Flash Instruction Tracing | Dominik Zürner"
source_id: 46725389
excerpt: "QSPIの命令トレースでUARTパスワードをXIP実行領域から特定する手法を実践解説"
---

# Extracting a UART Password via SPI Flash Instruction Tracing - SPIフラッシュ命令トレースでUARTパスワードを抽出する
デバッグ端子が無効でも突破可能──外付けQSPIを覗いてUARTのパスワードを特定する実践ガイド

## 要約
外付けQSPIフラッシュのXIP読み出しをロジックアナライザでトレースし、実行される命令領域を特定してUARTコンソールのパスワード検査ロジック（およびパスワード自体）を見つける手法を紹介する。

## この記事を読むべき理由
デバッグポートが無効化された、あるいはそもそもデバイスにデバッガがない組み込み機器が増える中で、フラッシュの命令トレースは「動的解析に近い」手段として有効。国内の安価なスイッチやIoT機器にも同様の構成（外付けQSPI＋小型MCU）が多く、実務・趣味どちらにも役立つスキルです。

## 詳細解説
- 対象と背景：Realtek RTL8372N搭載の安価な管理スイッチ。管理ファームは8051コア上で動き、ファームは外付けQSPI（例：W25Q16）に置かれXIPで実行されるため、フラッシュ通信を覗ければ実行コードの所在が分かる。
- なぜ普通のダンプだけでは足りないか：8051は64KB空間しか持たず、実機では「コードバンキング（bank switching）」で複数バンクを切り替えて数メガバイトのフラッシュを使う。静的にダンプして文字列探索するだけでは、どのバンクが実行時に参照されるか分からず解析が難しい。
- アプローチ：起動時・パスワード入力時などでQSPIの読み出しをロジックアナライザで記録し、読み出しアドレス列（＝XIPでCPUにロードされる命令の位置）を取得。入力前後のトレースを差分すると、パスワード検査や比較に関わるコード領域が絞れる。
- 必要機材と注意点：
  - サンプリング速度：XIP命令は高速（例：8–60 MHz系）。実務ではクロックの4倍前後のサンプルが目安のため、400 MS/s 程度が望ましい。SaleaeやSLogic16U3が選択肢になるが、データ転送方式やドライバに注意。
  - 接続：SOICクリップは手軽だが安定性に欠けるため、基板にピンヘッダを追加して確実に接続すると解析効率が上がる。
  - ソフト：PulseViewでSPIフラッシュ解析を行い、読み出しコマンド（fast read）のアドレス／データ一覧を出力する。
- 解析手順概略：
  1. フラッシュ全体を一度ダンプしてバックアップ（暗号化無しなら容易）。
  2. 起動状態でQSPIをキャプチャ（idle）→パスワード入力状態で再キャプチャ（試行錯誤用に誤パスも）。
  3. 各キャプチャから読み出しアドレスと読み長を抽出（PulseViewの解析器→テキスト出力）。
  4. スクリプトでフラッシュ物理アドレス→8051のバンク付きアドレス空間にマッピング（0x0000–0x3FFFは共通、0x4000+が各バンクへ対応）。
  5. 2つのトレースを差分して、パスワード処理に使われる領域を特定。そこをGhidraでバンク毎に読み込み、関数や文字列を追う。
- スクリプトの役割：フラッシュアドレスをバンク形式に変換、実行トレース表示、ユニークアドレス（カバレッジ）表示、出力にASCII解釈を付けるなどで手作業の逆解析を大幅に短縮する。

## 実践ポイント
- まずはフラッシュ全体を安全にバックアップしてから解析を始める（任意のデバイス改造時の基本）。
- キャプチャは「状態を変えた2回以上」を用意する（idle vs. パスワード入力など）。差分で注目領域が見つかる。
- 必要サンプルレートを満たすロジックアナライザを用意する（実効速度・USB転送制約に注意）。
- 8051のコードバンキング構造を理解してマッピングスクリプトを用意するとGhidraでの追跡が楽になる。
- 基板にヘッダを立てて物理的に安定した接続を確保すると解析作業が圧倒的に楽になる。

（参考技術：RTL8372N + 8051、W25Q16系QSPI、XIP、コードバンキング、PulseView/SLogic/Saleae、Ghidraオーバーレイ）
