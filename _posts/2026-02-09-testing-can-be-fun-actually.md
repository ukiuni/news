---
layout: post
title: "Testing can be fun, actually - テストは実は楽しい"
date: 2026-02-09T04:40:13.899Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://giacomocavalieri.me/writing/testing-can-be-fun-actually"
source_title: "Testing can be fun, actually"
source_id: 1182166387
excerpt: "スナップショットで出力を可視化し、差分レビューでテスト保守を劇的に楽にする"
---

# Testing can be fun, actually - テストは実は楽しい
テストが楽しくなる！スナップショットテストで保守が劇的にラクになる方法

## 要約
スナップショットテストは「期待値を自動で保存／レビュー」してくれる手法で、単調で壊れやすい文字列比較や複雑な出力の検証を圧倒的に楽にする。Gleam/Rustの大規模プロジェクトでも実運用されている実績がある。

## この記事を読むべき理由
テストの作成・保守は時間を食う作業です。日本の現場でもCLI、型推論や言語ツール、アニメーション等、出力の変更を扱う場面が多く、スナップショットでレビューを導入するだけでコードレビューと親和性の高いワークフローにできます。

## 詳細解説
- 問題点：ヘルプ文や複雑な構造体を文字列で逐一アサートすると、変更時に手作業で期待値を書き換える必要があり面倒でミスが起きやすい。
- 解決策（スナップショット）：テスト実行時に「新しいスナップショット」を生成し、人がレビューして accept/reject する。accept すると期待値ファイルが保存され、以降は差分があればテストが失敗して再レビューを促す。バージョン管理との相性が良く、diffで変化箇所を即把握できる。
- 実例：
  - CLIのhelp文：長大な文字列を手で書く代わりにスナップショットで保存・レビュー。
  - Language Serverのhover出力：そのまま raw dump を取ると読みにくい。表示位置や内容が一目で分かる「可読フォーマット」でスナップショット化するとレビューが速い（Gleamコンパイラは3000+のスナップショットを運用）。
  - 数学的関数（イージング）：複雑な Float の点検は難しいが、関数をプロット（ASCII 等）して形を保存すれば挙動の比較が直感的になる。
- 実装ポイント：非文字列は意図的に文字列化する（フォーマットを設計する）。雑な to_string より「レビューしやすい」出力を目指す。

コード例（従来の手動アサート）：
```gleam
// gleam
pub fn help_text_test() {
  assert cli.help_text() == "usage: ... -h, --help show this help text"
}
```

コード例（スナップショット、birdie の例）：
```gleam
// gleam
import birdie

pub fn help_text_test() {
  cli.help_text() |> birdie.snap(title: "testing the help text")
}
```

## 実践ポイント
- まずは小さな箇所（CLI出力、JSONレスポンス、HTML断片）から導入する。
- スナップショットは「人が読みやすい形」で保存する（位置情報や可視化を付ける）。
- スナップショットファイルは必ずVCSで管理し、差分レビューをルール化する。
- 非文字列は目的に合わせてフォーマット（例：hover → ソース＋カーソル表示、関数 → ASCIIプロット）してからスナップショット化する。
- 既存CIに組み込み、変更があればレビュー→承認フローを定着させる。

短時間で可視化とレビューを回せるので、テスト作業が「つまらない作業」から「価値あるレビュー」に変わります。まずは一箇所、試してみてください。
