---
layout: post
title: "Filtering as domain logic - フィルタリングをドメインロジックにする"
date: 2026-01-20T01:22:42.165Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://blog.ploeh.dk/2026/01/19/filtering-as-domain-logic/"
source_title: "Filtering as domain logic"
source_id: 422499525
excerpt: "SQLは粗めにしてドメイン側で精密なフィルタを実装し、テスト可能で正確な選別と高性能を両立する方法"
image: "https://blog.ploeh.dk/content/binary/double-funnel-architecture.png"
---

# Filtering as domain logic - フィルタリングをドメインロジックにする
複雑なWHERE句に頼らず、テスト可能な「ドメイン側フィルタ」で正確さと保守性を両立する方法

## 要約
サーバ側（SQL等）での絞り込みを「粗め」に留め、正確な選別はアプリ側のドメインロジックで行う——こうすることでテストしやすく、正しさを担保しやすくなるという考え方です。

## この記事を読むべき理由
- 大規模データを扱う日本のサービス（EC、チケット、予約管理など）で「高速さ」と「ビジネス的正確さ」を両立したいなら即役立つ設計パターンです。
- SQLの複雑なクエリを信頼するのが怖い／変更が多いチームで、ユニットテスト中心の品質管理をしたい場合に効果的です。

## 詳細解説
問題
- データベースに対して「必要な行だけ」を取るためにSQLは便利ですが、条件が増えるとSQLは複雑化し、正しさを検証しにくくなります。
- DBテストは遅くてメンテが大変。変更時の安全性（回帰）を素早く検証したい場面が多いです。

考え方
- サーバ側クエリは「パフォーマンス用の粗いフィルタ」を担当する（例：日付範囲や特定店舗のレコードだけを返す）。
- 真のビジネスルールに基づく精密なフィルタは、アプリ側（ドメインモデル）で実装する。アプリ側ならユニットテスト、静的解析、プロパティベーステストなどで堅牢にできる。

重要な注意点
- サーバ側の絞り込みが「必要なレコード」を取りこぼさないこと。取りこぼしはドメイン側では回復不能。
- したがってサーバ側は「やや広め（wider）」にデータを返し、クライアント側で不要なものを捨てる設計にする。

実装例（概念）
- 予約システムでの抜粋（C#）
```csharp
public bool WillAccept(DateTime now, IEnumerable<Reservation> existingReservations, Reservation candidate)
{
    var seating = new Seating(SeatingDuration, candidate.At);
    var relevant = existingReservations.Where(seating.Overlaps);
    // relevant に対して受け入れ判定を実行
}
```

- Overlaps を持つドメイン型（テスト可能で純粋なロジック）
```csharp
public bool Overlaps(Seating other)
{
    return Start < other.End && other.Start < End;
}
```

利点
- ドメインロジックがユニットテスト可能になり、仕様変更に強い。
- パフォーマンスと正確性の関心事を分離できる。
- クエリを粗くするとキャッシュヒット率が上がる（例：日付単位でキャッシュするなど）。

トレードオフ
- ロジックの重複（サーバ側の粗い絞り + クライアント側の厳密な絞り）が発生する。
- データ量が小さければ全てクライアントでやる方がシンプル。
- サーバ側で誤って必要な行を除外すると致命的。

## 実践ポイント
- まず判断：そのフィルタは「性能上の必須」か「ドメインの正しさに必須」かを分ける。
- サーバ側（SQL）は「性能用の粗い境界」だけ残す（例：日付レンジ、店舗ID）。
- ドメイン側に判定ロジック（Seating.Overlapsのような純粋関数）を実装し、網羅的にユニットテストを書く。
- サーバ側クエリは「必ず広め」にして取りこぼしがないことを確認する。境界条件は余裕をもって設計（例：前日・翌日を含める）。
- 小さなデータセットや単純ロジックならサーバ側だけで完結させる判断もあり。
- キャッシュを使う場合は、粗いクエリにすることでキャッシュ効率が向上する点を活用する。
- ドメインフィルタをライブラリ化して再利用・バージョン管理することで、複製の管理コストを低減する。

日本市場との関連（短く）
- レストラン予約やEC、サポートチケットなど、ボリュームが大きくビジネスルールが厳密な領域が多い日本のプロダクトに特に有効です。夜をまたぐ営業時間や祝日のローカルルールなど地域特有の例外処理はドメインで扱うと安全です。

このパターンは「いつもやるべき」ではありませんが、SQLが複雑化して正しさの担保が怖くなったときに非常に有効なツールとなります。
