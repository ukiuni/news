---
  layout: post
  title: "Profiling with Ctrl-C (2024) - Ctrl-Cでプロファイリングする"
  date: 2026-01-03T15:29:03.915Z
  categories: [tech, world-news]
  tags: [tech-news, japan]
  source_url: "https://yosefk.com/blog/profiling-with-ctrl-c.html"
  source_title: "Profiling with Ctrl-C"
  source_id: 46475296
  excerpt: "Ctrl-Cで実行中プロセスのホットスポットを即発見し対処につなぐ実用法"
---

# Profiling with Ctrl-C (2024) - Ctrl-Cでプロファイリングする
Ctrl-Cで「迷走中のプログラム」を一発で暴く――手抜き環境で効く即席プロファイル術

## 要約
デバッガで実行中プロセスにCtrl-Cを入れてスタックを覗く“Ctrl-Cプロファイリング”は、環境が不親切で時間がないときに非常に実用的だが、サンプリングの性質上、すべての性能課題を解決するわけではない。

## この記事を読むべき理由
日本の開発現場では、クロスコンパイル、組み込みボード、CIの制約、デバッグビルドの遅さなど「いい道具を使う余裕がない」状況がよく起きます。手間をかけずに原因を切り分けるテクニックとして、すぐに試せる実務的な手法と限界・次の一手を学べます。

## 詳細解説
- 手法の本質  
  Ctrl-Cプロファイリングは、実行中のプロセスを乱数的に（あるいは都合の良いタイミングで）中断してコールスタックを得る、簡易的なサンプリングプロファイラです。デバッガさえあればほぼどんな環境にも使え、特別なビルド（-pg 等）も不要、フレームポインタが無くてもスタックが取れるケースがあるため取り回しが良い。

- 実例で見る効果  
  デバッグビルドで起動が1分かかる原因を何度かCtrl-Cしてみたら、nlohmann::jsonの大量なフレームが並ぶ――というような単純なホットスポットは、手早く報告して直してもらえることが多いです。別例として、LLDでリンクしたバイナリのコア読み込みでgdbが遅い場合、Ctrl-Cでスタックを覗くとDWARF処理（例：dwarf_decode_macro_bytes）に問題があると分かることがあります。結果として-ggdb3を外す、リンク設定を変えるなどの実用的な対処で解決します。

- 限界と、なぜプロファイラが必要か  
  Ctrl-Cは低サンプリング頻度のため、プログラム全体に微妙に散らばった性能劣化や、稀に発生する遅延（tail latency）を捕まえられないことがあります。多スレッド／マルチプロセス／分散システムではランダム一時停止だけでは状況把握が難しい。命令レベルや分岐命令の違い（例：MIPS/RISCのrelocation relaxationによる分岐命令の差）まで突き止めるには、シミュレーションベースやインストラクション単位で解析できるプロファイラが必要です。さらに、トレース（ftrace等）は尾部遅延の具体例を取るには向いているが、どの関数が時間を消費しているかは分かりにくい、という棲み分けがあります。

## 実践ポイント
- まず試す（コストがほぼゼロ）  
  1. プロセスにアタッチしてCtrl-Cで何度かスタックを取る。パターンが出るかを確認。  
  2. 実行後にattachする例:
```bash
# bash
gdb /proc/$pid/exe $pid
# Ctrl-C を繰り返してバックトレースを見る
```
- 何を見ればいいか  
  同じ関数／ライブラリが繰り返し出るならホットスポット。ライブラリ名やビルドオプションが原因なら簡単に報告・対処可能。

- 簡単な対処案  
  - デバッグ情報を軽くする（例: -ggdb3 を外す）とgdb/リンク速度が改善する場合あり。  
  - LLDを使うならバージョン差（relaxationの有無）に注意。古いLLDだとRISCでの最適化を逃して速度低下を招くことがある。  
  - 組込／クロス環境ではデバッガでattachする手法が特に有効。

- 深追いが必要なら次へ進む  
  - サンプリングで曖昧な場合は perf / sampling profiler を本番で回す。  
  - 命令レベルや分岐差を知りたいなら callgrind 等のシミュレーションベースで差分解析。  
  - 尾部遅延は ftrace 等でトレースを取り、再現入力を収集して解析する。

Ctrl-Cプロファイルは「まず試す一手」として非常に有用です。短時間で因果の手がかりが掴めれば、それだけで現場の速度問題は多く解決します。見えない問題に深入りする前に、まずはCtrl-Cで覗いてみてください。
