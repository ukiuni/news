---
layout: post
title: "Functional programming in m4 - m4で関数型プログラミング"
date: 2026-02-11T20:59:47.359Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://www.tuhs.org/pipermail/tuhs/2020-August/022108.html"
source_title: "[TUHS] bare m4 (was BTL summmer employees)"
source_id: 1040242364
excerpt: "m4マクロだけで分岐・リスト・状態を操り計算機を実装する手法を平易解説"
---

# Functional programming in m4 - m4で関数型プログラミング
m4でマクロを“関数”化する古典トリック — マクロだけで算術・分岐・メモリを実装する方法

## 要約
古典的なTUHS投稿で紹介された手法を日本語で平易に解説。m4の「define」だけで条件分岐・リスト操作・再定義による状態管理を組み合わせ、実質的に関数型スタイルで計算機（チューリング完全）を実装する技法を示す。

## この記事を読むべき理由
m4は古いが、ビルドツールやコード生成に今も関わる日本の開発現場で遭遇することがある。マクロを“プログラム”として設計する発想は、DSL設計やメタプログラミング、軽量なコード生成技術の理解に直結する。

## 詳細解説
- 中心アイデア
  - m4の基本はdefine。これを「関数」「メモリ」「データ構造」として運用する。
  - 分岐はマクロ名を動的に作って呼ぶことで実現（例：if -> if_T / if_F を呼ぶ）。
- 主要テクニック
  1. マクロ名の組み立てによるケース分岐（動的ディスパッチ）。
  2. 右結合の括弧リストでリストを表現（終端は `()`、小さい方の桁が先＝リトルエンディアン）。
  3. defineで名前を持つマクロを直に書き換え、状態（メモリ・カウンタ）を表現。
- 例（簡略）
  - if の実装（分岐はマクロ名で決定）:
    m4
    define(if,`if_$1(`$2',`$3')')
    define(if_T,`$1')
    define(if_F,`$2')
  - head/tail によるリスト操作:
    m4
    define(head,`_head$1')
    define(_head,`$1')
    define(tail,`_tail$1')
    define(_tail,`$2')
  - これらを組み合わせ、1ビットずつの加算（succ）や全ビット加算（add）を構成。2引数のスイッチを自動生成するヘルパ（cases1, cases2）で記述量を減らす。
- 応用と限界
  - 文字列比較の最適化トリックや、$N^2$ による組合せ爆発の回避法（事前にケースを生成するなど）を駆使する。
  - 再定義で擬似的なメモリや命令カウンタを作り、分岐命令でカウンタを書き換えることで「プログラム実行」を実現。これによりm4は理論上チューリング完全。
  - 実用上の問題点：可読性、保守性、実装によっては末尾再帰最適化がなくスタックが深くなる点。

## 実践ポイント
- 小さく試す：まず head/tail と if の組み合わせで小さな数（リスト）を作り、base2で表示してみる。
- マクロ名生成を活かしたディスパッチは、DSL的な命令セットやコード生成に便利。
- 状態が必要なら define による再定義（incrパターン）を使う。ただし大規模処理は別言語（Python/Rust/Haskell等）に任せる。
- 参考実装から学べる設計原則：データを文字列リテラルで表現する、ケース生成を抽象化する、再利用可能なスイッチジェネレータを作る。

この手法は「歴史的名作」かつ発想の教科書的な価値が高いので、マクロ言語やメタプログラミングを学びたい日本のエンジニアには強くおすすめ。
