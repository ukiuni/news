---
layout: post
title: "Read, then write: batching DB queries as a practical middle ground - 読んでから書く：DBクエリのバッチ処理は実用的な折衷案"
date: 2026-02-16T17:22:43.809Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://fragno.dev/blog/db-batching"
source_title: "Read, then write: batching DB queries as a practical middle ground | Fragno Blog"
source_id: 440305025
excerpt: "読み取りを一括送信してアプリで処理後まとめて書き込むことで往復を減らし可読性と性能を両立する実践的手法"
image: "https://fragno.dev/social.webp"
---

# Read, then write: batching DB queries as a practical middle ground - 読んでから書く：DBクエリのバッチ処理は実用的な折衷案
使い慣れた手続きコードのままラウンドトリップを減らす「バッチ（パイプライン）」という現実的テクニック

## 要約
アプリのラウンドトリップを減らす手段として、インタラクティブトランザクション（逐次クエリ）とCTE（単一クエリ化）の中間にある「バッチ／パイプライン」が有効。読み取りをまとめて送り、アプリで処理してから書き込みをまとめる手法で、可読性と性能のバランスが取れる。

## この記事を読むべき理由
N+1問題や過剰な往復はどの言語／フレームワークでも悩みの種。特に日本の多くのCRUD中心のサービスでは、可読性を犠牲にせず遅延を減らしたい場面が多く、この手法はすぐ役立ちます。

## 詳細解説
- 問題点：ループ内でDBクエリを投げると毎回ラウンドトリップ（往復）が発生し遅くなる（N+1）。また、逐次的にトランザクション内で読み書きすると往復数が膨らむ。
- 解決の一般手段：
  - CTE（WITH句）で読み取り〜計算〜挿入を1回のSQLで済ませる → ラウンドトリップは1回。ただしロジックが宣言的になり、複雑な計算や早期リターンが書きにくい。
  - バッチ／パイプライン（中間案） → 複数の読み取りクエリをパイプラインで一括送信し、結果をアプリ側で処理してからまとめて書き込む。手続き的なコードを保ったまま往復数を削減できる。
- 特徴：
  - 読み取りフェーズ：複数クエリを非同期に順次送信（ドライバがパイプラインをサポートしていれば1ラウンドトリップ相当）。
  - アプリ側でビジネスロジック（分類・ケース分岐など）を実行。
  - 書き込みフェーズ：まとめてINSERT/UPDATEを発行（1ラウンドトリップ）。
  - トランザクションの意味合いは逐次トランザクション／CTEとは異なるため、原子性や競合処理は設計が必要（楽観的ロックなど）。
- サービス間の適用：リクエストスコープのコーディネータで各サービスの読み取りを一括、書き込みを一括にすることで、複数サービスにまたがっても往復は2回で済む設計が可能。

簡単な対比コード（概念）：

```javascript
// javascript: 逐次トランザクション（往復多め）
await tx.select(...user check...);
await tx.select(...order count...);
await tx.insert(...membership...);
```

```javascript
// javascript: バッチ／パイプライン（読み取りまとめ→処理→書き込み）
const [user, stats] = await db.pipeline([q1, q2]); // 読み取りを一括送信
if (!user.enrolled) return null;
const tier = computeTier(stats);
await db.insert(...membership...); // 書き込みをまとめる
```

## 実践ポイント
- まずは往復数を計測（プロファイル）して効果を確認する。
- 使用するDBドライバ／クライアントがパイプラインをサポートしているか確認。未対応なら独自バッチレイヤーで疑似的にまとめることも。
- アトミック性が必要な書き込みは別途トランザクションで保護するか、楽観的競合検知（version／ETag）を導入する。
- 複雑な計算はアプリ側でやるか、SQLでやるかをコストと可読性で判断する（バッチは可読性重視の中間選択）。
- 日本の既存業務アプリやマイクロサービス構成にも導入しやすく、チームの可読性重視の方針に合う場合が多い。

この記事で示した「読み→処理→書き」の二相モデルは、実務で即使える折衷策です。まずはホットパスの往復数を減らすところから試してみてください。
