---
  layout: post
  title: "On scannerless parsing again - スキャナレスパースを再考する"
  date: 2026-01-04T23:57:38.923Z
  categories: [tech, world-news]
  tags: [tech-news, japan]
  source_url: "https://wareya.wordpress.com/2026/01/04/short-bit-on-scannerless-parsing-again/"
  source_title: "Short bit: on scannerless parsing again &#8211; Abandonculture"
  source_id: 1035324621
  excerpt: "スキャナレスは遅いという誤解を覆す、中間型パーサで性能と正確性を両立する方法"
  image: "https://s0.wp.com/i/blank.jpg?m=1383295312i"
---

# On scannerless parsing again - スキャナレスパースを再考する
「スキャナレス＝遅い」は本当か？知られざる“中間型”パーサが変える選択肢

## 要約
「スキャナレス（scannerless）」という言葉は一義的ではなく、入力をどう「チャンク（区切り）」し、そこに名前を付けるかで3つの実装スタイルに分かれる。性能・正確性の違いは実装スタイル次第なので、単に「スキャナレスだから遅い／扱いにくい」と決めつけるのは誤りだ。

## この記事を読むべき理由
日本でもコンパイラ、静的解析、DSL、ハイパフォーマンスなデータ処理（例：simdjson）を作るチームが増えています。パーサ設計の誤解は性能や互換性の落とし穴になり得るため、選択肢を正しく理解して適切に使えることは実務上の大きな利点です。

## 詳細解説
ポイントを整理します。

- 用語の混同
  - 「スキャナレス」と聞いて人々が想定するものは主に二通り：
    1. 文字単位で文法を書く（いわゆる“真の”スキャナレス）。正規表現／文字ごとの規約で直接解析する方式。
    2. 文字列や正規表現で入力をチャンクするが、チャンクに名前（トークン種別）を与えない方式（中間型）。
    3. チャンクしてそれぞれに名前を与える（伝統的なレキシング＝トークン化）。
  - 注意：2と3は「チャンクしている」点で共通でも、トークン名を付けるか否かで挙動が変わる。

- 実装と性能の関係
  - 歴史的には1と3が主流だったが、メモリやキャッシュ性能、Packratやパーサコンビネータ、Earleyの高速化により2も現実的になった。
  - Packrat実装が見た目では1（スキャナレス）っぽくても、内部で文字列インターンなどを使って実質的に2になっているケースがある。つまり「見た目＝遅い」は当てにならない。
  - simdjsonのようなフォーマット固有のパーサは、アドホックにチャンクして高速化しつつレキシング（トークン名付与）を行わない設計を取ることがある。

- 正確性への影響
  - チャンクの有無・時期によって、受理する言語が微妙に変わる（Earleyの「チャンクあり／なし」で解析できる入力集合が異なる）。
  - 「ソフトキーワード」（文脈依存でキーワードになる語）を扱う際、従来型の手早いレキサー（先に完全にトークン化する）では困難。LR系は特に、パーサの直前で文脈情報に基づくオンデマンド・レキシングをする設計が有利なことがある。

- 実務的含意
  - 「スキャナレス＝設計上の簡潔さだが遅い」と決めつけず、どの“型”か明確にすることが重要。
  - 設計段階でチャンク処理のタイミング（いつどれだけ判定／識別するか）を仕様に落とし込むと、後で性能や曖昧さで悩みにくい。

## 実践ポイント
- 設計時に「scannerless の何型か」を明示する（1: per-char、2: chunk-only、3: chunk+named tokens）。
- ソフトキーワードや文脈依存のトークンがある言語なら、オンデマンドレキシングを検討する（LR系ツールでの現実的対応）。
- Packrat／パーサコンビネータを採用する場合は、文字列インターンやメモリ消費を含めてベンチマークを取る。見た目の「スキャナレスさ」に惑わされない。
- 高速フォーマット解析（大量データのJSON等）では、simdjson的なチャンク主体の戦略が有効。用途に応じて「完全なトークン化」を諦める選択肢もある。
- ドキュメントとチーム合意：パーサの分類とその理由（性能・正確性トレードオフ）をコードレビューや設計ドキュメントで共有すること。

短く言えば、スキャナレス／レキシングの話は「単語の定義競争」になりがちで、実務では「いつ」「どれだけ」チャンクを確定するかが最重要です。選択肢を正しく理解すれば、パーサ設計の誤った先入観を取り除き、より適切なツールと実装を選べます。
