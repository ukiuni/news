---
layout: post
title: "I built a self-hosted code search platform with bulk find-and-replace across repos - リポジトリ横断の一括検索・置換を備えたセルフホスト型コード検索プラットフォームを作った"
date: 2026-01-14T21:19:09.667Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://techquests.dev/projects/code-search"
source_title: "Code Search"
source_id: 426700024
excerpt: "セルフホストで数百リポジトリを瞬時に検索・一括置換して自動PR作成する実運用向けツール"
image: "https://techquests.dev/_app/immutable/assets/cs_landing.B9B_h_9U.png"
---

# I built a self-hosted code search platform with bulk find-and-replace across repos - リポジトリ横断の一括検索・置換を備えたセルフホスト型コード検索プラットフォームを作った
50のマイクロサービスを一発で置換？自前で作る「コード検索＋一括修正」ツールの全貌

## 要約
リポジトリを横断して超高速検索でき、見つけたコードをプレビューして一括置換→自動でMR/PRを作るセルフホスト型プラットフォームの紹介。プライバシー重視で複数ホストを同時に扱え、スモールチームから大規模環境までスケールする設計になっている。

## この記事を読むべき理由
日本企業でもマイクロサービス化やレガシーAPI置換、内部監査が増えています。膨大なリポジトリ群を「探す・変える」を手作業でやるのは非現実的。自前で運用でき、コードを外部に出さないソリューションは法令遵守や社内ポリシーに合致しやすく、実務で即役立ちます。

## 詳細解説
- 何ができるか  
  - 超高速検索：Zoektというトライグラム（3文字の組み合わせ）ベースのインデックスでサブ秒検索を実現。正規表現、リテラル、構造的クエリ（構文に依存した検索）をサポート。  
  - 一括置換：何百リポジトリにもまたがるパターンを検出して置換し、変更差分をプレビューした上で自動的にマージリクエスト／プルリクエストを作成。ロールバックも可能。  
  - プライバシー指向：セルフホストでコードは自社サーバから出ない。テレメトリ無し、外部依存を最小化。  
  - マルチホスト対応：GitHub/GitLab/Bitbucket/Giteaなどを同時接続・混在検索可能。

- アーキテクチャ（要所）  
  - フロントエンド：Next.js + TypeScriptで検索画面・ファイルブラウズ・差分プレビューを提供。  
  - API：Go製のREST API（OpenAPI仕様あり）で検索・リポジトリ管理・ジョブ制御を担当。  
  - インデクサー：Goで書かれたサービスがリポジトリをクローンしてZoekt向けのトライグラムインデックスを構築。オンデマンド／常駐どちらも可能。  
  - CLI：自動化やパワーユーザー向けの端末操作。  
  - ストレージ：PostgreSQL/MySQLでメタデータ、Redisでジョブキューやキャッシュ。  
  - デプロイ：小規模はDocker Compose、大規模はHelm/Kubernetesで水平スケール。観測はOpenTelemetry/Prometheus。

- 開発で得た知見（要点）  
  - インデックス性能：Zoektは速いがビルド時のメモリ・並列化調整が鍵。  
  - 分散処理：Redisキューでワーカー調整、同時更新の競合回避が重要。  
  - API設計：フロントエンドとCLI両方を支えるため、ストリーミング検索や長時間ジョブの扱いを考慮した設計が必要。  
  - DB最適化：大量リポジトリではシャーディングや接続プールの運用が効く。

## 実践ポイント
- 小さく始める：まずはDocker Composeで社内の代表的な数リポジトリをインデックスして挙動を確認。  
- 検索戦略：最初はリテラル検索→正規表現→構造検索の順で絞ると誤検出が減る。特に置換は必ず差分プレビューを確認。  
- 自動化ルール：よくある置換（バージョン番号、Deprecated API）はCLIでスクリプト化し、CIに組み込むと安全に運用できる。  
- プライバシー要件対応：ソースを外部に出せない場合はセルフホストが最有力。ホスト接続には最小パーミッションのアクセストークンを使う。  
- リソース監視：インデクシングはメモリとIOを使うためPrometheusで監視し、Zoektのパラメータやワーカ数を調整する。  
- 拡張候補：シンボル跳び（jump-to-definition）や履歴検索（diff search）を使うならSCIPやコミット履歴検索の導入を検討。  
- 運用上の注意：DBバックアップ、リポジトリクローンのキャッシュ、ロールバック手順を整備しておく。

このプラットフォームは「どこで何が使われているか」を即座に答え、変更作業を安全に自動化するツールです。日本の現場でも、レガシーAPI置換・大規模リポジトリの整理・内部監査対応などで即戦力になります。興味があれば小さな検証環境を立てて、まずは検索→差分プレビューまでを試してみてください。
