---
layout: post
title: "Lessons from creating a gaming-oriented scheduler - ゲーム向けスケジューラ開発から得た教訓"
date: 2026-01-20T10:27:29.963Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://lwn.net/Articles/1051430/"
source_title: "Lessons from creating a gaming-oriented scheduler [LWN.net]"
source_id: 1618851287
excerpt: "LAVDでLinuxゲームの低1%遅延を改善し、カクつき解消に挑む"
---

# Lessons from creating a gaming-oriented scheduler - ゲーム向けスケジューラ開発から得た教訓
Linuxでゲームの「カクつき」を減らす新戦略：Steam Deck発のLAVDが挑むスケジューリング革命

## 要約
Linux上でWindows向けゲームをより滑らかに動かすため、LAVD（latency-criticality aware virtual deadline）というゲーム特化スケジューラがBPF＋Rustで開発され、実機プロファイリングや新しいベンチ／トレースツールの必要性が浮き彫りになりました。

## この記事を読むべき理由
ゲームは一般的なアプリと違い「FPS（frames-per-second）」という明確な体感指標を持ち、特に「低い1%（low 1%）」、つまり99パーセンタイルの遅延がカクつきの主因になります。Steam DeckやSteamOS対応を進める日本の開発者・QA担当・Linux好きゲーマーにとって、スケジューリング改善は体感品質とバッテリー効率に直結する重要テーマです。

## 詳細解説
- ゲーミングの評価軸：平均FPS（スループット）と低い1%（レイテンシのひっかかり＝スタッタ）の両方が重要。平均が高くても低い1%が落ちれば体験は悪化します。  
- LAVDの狙い：FPS低下やスタッタを起こしやすい「レイテンシ重視」タスクを優先化し、全体として低1%を上げること。実装はカーネルの拡張クラス（sched_ext）を使い、主要ロジックをBPFで、ユーザー空間の薄い部分をRustで構成しています。  
- ゲームの処理特性：多くのゲームタスクは短時間（典型1ms、まれに数ms、さらに100µs未満の超短タスクも）で終わる。1つのユーザ操作は数十のスレッドやカーネル・ドライバの協調で完結することが多く、「waker/wakee（起こす側／起こされる側）」の頻度が高い連鎖を優先するのが鍵です。  
- スケジューラの3大決定：どのタスクを先に実行するか、どれだけ長く走らせるか（タイムスライス長）、どのCPUコアで走らせるか。これらは性能・エネルギー効率・オーバーヘッドのトレードオフになります。特にバッテリー駆動のデバイス（例：Steam Deck）ではbig/medium/littleコアの組合せ最適化が重要です。  
- 計測とツールの不足：Min氏はVaporMark（perf sched recordのデータを集計する自作ツール）やPerfettoで解析したが、まれにしか起きない遅延スパイクを検出・相関付けるのが難しいと指摘。高レベルのトレースと微視的解析を繋ぐツールや、ゲーム向けに特化したベンチマーク群（gamesuite）が求められています。  
- ベンチマークの課題：一般的なベンチは平均値しか出さないことが多く、低1%や最小FPSが取得できない／ゲームのアップデートで結果が変わる／サーバ依存で再現性が低いなど問題が多い。既存のマイクロベンチ（stress-ng等）はスケジューラ負荷を測るがゲーム体感改善に直結しない場合もあります。  
- 同期／ロックの問題：WindowsゲームはWindowsの同期プリミティブを前提にしており、Wine経由でfutexにマッピングされるため、ロック関連の「ロックホルダの先送り（priority inversion）」が致命的になることがある。カーネル側のproxy executionやntsnyc（ntsync）ドライバの導入、futex APIの改良が進んでおり、LAVDもロック保持を考慮した長めのタイムスライス付与などで対処を試みています。  
- その他のアイデア：ゲームごとのプロファイルを使う「プロファイルガイド付きスケジューリング」や、GPU情報をCPUスケジューリングに活かす試み、WF_SYNC フラグの利用（起床後すぐにスリープに戻るタスクをヒントとして伝える）などが議論されました。

## 実践ポイント
- FPS評価は「平均」だけでなく「低い1%／最小FPS」を必ず取る。MangoHudは有用だがバッチロギング設定でゲームに干渉するので注意して使う。  
- 再現性あるベンチを作る：ネットワーク非依存のシーンを使う、乱数シードを固定する、サーマルスロットリングを抑える（冷却・性能制限の固定）などをルール化する。  
- トレース取得：まずは perf sched record で大量データを取り、VaporMark的な集計でタスク寿命やwaker/wakeeの関係を把握する。極端なスパイクは長時間のサンプリングやイベントトリガを工夫して捕まえる。  
- Linux上のWindowsゲーム対応を改善したいなら、futexの挙動とロックの影響を意識する。Wine/Protonの同期実装とカーネル側の改善（ntsync, proxy exec）をフォローすると効果が出やすい。  
- 開発者/コミュニティにできること：代表的なゲームを集めた「gamesuite」を提案・整備したり、MangoHudの推奨バッチ設定を公開したり、ゲームエンジン別のプロファイルを共有すると再現性ある評価基盤が作れます。

LAVDの取り組みは始まったばかりで、ツール整備やベンチ環境、OS側の同期改善が揃えば、Linux上でのゲーム体験は着実に良くなっていきます。Steam DeckやSteamOSに関心があるなら、今後のLAVDやsched_ext周りの進展を追う価値があります。
