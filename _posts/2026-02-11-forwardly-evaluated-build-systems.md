---
layout: post
title: "Forwardly-evaluated build systems - 先読み評価（順方向評価）ビルドシステム"
date: 2026-02-11T15:35:40.696Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://garnix.io/blog/garn2/"
source_title: "Garnix Blog: Forwardly-evaluated build systems"
source_id: 866057376
excerpt: "garnがTypeScript＋厳密トレースでNix評価を秒→数十ミリ秒に短縮"
---

# Forwardly-evaluated build systems - 先読み評価（順方向評価）ビルドシステム
Nixの評価コストをTypeScriptと精密キャッシュで秒→ミリ秒に縮める──garnが示す実践的アプローチ

## 要約
Nixの「評価（evaluation）」フェーズを高速化するため、TypeScriptをフロントエンドにして評価時の読み取り（reads）をトレース／ハッシュ化することで厳密なキャッシュを実現したgarn（garn2）の手法と効果を解説する。結果として未変更時は評価が数十ミリ秒に落ち、モノレポやCIでの無駄な再評価が大幅に減る。

## この記事を読むべき理由
- 日本でもモノレポやCI重視の開発が増加中で、評価時間がビルド・フィードバックループのボトルネックになりやすい。  
- Nixを使うチームや評価コストに悩むプロジェクトに、実用的な改善手法（言語置換＋トレースキャッシュ＋メモ化）が提示されているため即応用価値が高い。

## 詳細解説
- 問題点（文脈）  
  - Nixの処理は「式の評価 → derivationファイル生成 → ビルド」という流れで、評価だけで数分かかることがある。評価はdevshellやCIの応答性を悪化させる。IFD（import-from-derivation）などの双方向依存も評価性能を悪化させる要因。  
- garnの基本方針  
  - 評価言語をTypeScript（V8）に置き換え、書き込みやネットワークなど副作用をほぼ除外した専用ランタイムを用意。許可された「primop」だけ（readFile, path, importなど）を提供し、実行はGarn.lockと実際に読んだファイル一覧に依存する純粋な関数扱いにする。  
- トレースベースのキャッシュ  
  - 評価時に「garn.tsのハッシュ」と「評価中に行った読み取りの一覧とそれらのハッシュ」を記録。次回はこれらが変わらなければキャッシュを返すため、リポジトリの他部分が変わっても依存していない評価は再計算を避ける。従来のflakeキャッシュがリポジトリ全体の変更で無効化されがちなのに対し、garnは依存精度が高い。  
- メモ化（incrementalism）  
  - memoize APIを導入し、別スクリプト単位で計算を分離・キャッシュ可能に。getArgs/getTargetなどを副作用としてトレースすることで、異なるターゲット間で再利用できるキャッシュの幅を広げる。Web Workerを使い並列性も確保。  
- ベンチマーク（要点）  
  - 代表的な比較：garnでの素の評価はおおむね数百ミリ秒（例: 約455ms）、既存のdefault.nix/flake.nixはそれより遅く、cacheヒット時はgarnが数十ミリ秒（例: ~16ms）まで短縮。READMEのような無関係な変更でgarnはキャッシュ継続する割合が高い（例: 大規模リポジトリでは多くのコミットで無効化されない）。memoize導入で部分的再評価の時間もさらに改善。

## 実践ポイント
- 評価を速くしたいなら「評価レイヤーの副作用を言語レベルで限定」し、読み取りトレースで厳密な入力セットを作ると効果が大きい。  
- 大規模リポジトリやCIでは、全体キャッシュではなく「実際に依存したファイルのみ」をキーにすることで再評価頻度を劇的に下げられる。  
- expensive な評価処理は memoize で分割して独立キャッシュ化し、getTarget などで対象選択をトレースすると異なるターゲット間での再利用性が向上する。  
- 導入時の注意：完全な互換性や追加実装コスト、キャッシュ管理の運用が必要。まずはdevshellやローカル再評価でボトルネックを特定し、段階的に適用するのが現実的。

（原論文／実装の詳細は元記事「Forwardly-evaluated build systems（garn2）」を参照のこと）
