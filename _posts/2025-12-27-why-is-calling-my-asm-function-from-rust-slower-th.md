---
layout: post
title: "Why is calling my asm function from Rust slower than calling it from C?"
date: 2025-12-27T15:41:09.951Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://ohadravid.github.io/posts/2025-12-rav1d-faster-asm/"
source_title: "Why is calling my asm function from Rust slower than calling it from C?"
source_id: 1373870731
excerpt: "同じASMなのにRust呼出しで命令1つ分遅延、原因と即効改善策を徹底検証"
---

# 同じASMなのにRustから呼ぶと遅くなる？rav1dで見つけた「たった1命令」の違い

## 要約
同一の手書きASMを使っているのに、Rust実装（rav1d）から呼ぶとC実装（dav1d）より一部関数が遅くなる現象を解析。原因はコンパイラの最適化が関数ポインタ越しのRust抽象を消せず、結果としてスタック配置やロード命令の取り扱いが変わったことだった。

## この記事を読むべき理由
同じネイティブASMを使っているのに呼び出し元の言語で性能差が出るのは、言語／コンパイラをまたいだ最適化の実務上の落とし穴を示す良い教訓。Rustで高速化を目指すエンジニアや、FFI／手書きASMを混ぜる開発者は必読。

## 詳細解説
- 観測手法  
  samply のサンプリングプロファイラの「asm view」を使い、命令ごとのサンプル数を比較。dav1d（C）とrav1d（Rust）で同一の `_neon` ASM関数を比較したところ、ほとんどは一致するが一つの関数だけ差が顕著だった。

- 問題の局所化  
  差は特定のロード命令に集中していた。該当命令はAArch64の以下のような命令列（抜粋）で、LLVM/アセンブリで同じソースになるはずの箇所。
  
  ```asm
  ld1 {v0.s}[2], [x13]
  ```
  この命令のサンプル数はC側で約 $10$、Rust側で $441$ と大きく異なっていた（サンプリング周波数 1000Hz で差は約 $0.35\ \mathrm{s}$、全体の約 $0.5\%$ に相当）。

- なぜそのようになるか  
  調査で判明したのは、Rust側のコンパイラが特定の抽象（関数ポインタをまたぐ形の表現）を最適化で消せず、その結果「関数呼び出し周りでより多くのデータをスタックに置く」コードになっていたこと。スタックレイアウトが変わると、アドレス計算やロードアドレス（ここでは x2 + オフセット → x13 など）が変わり、結果としてロードの発生頻度やキャッシュ挙動、レイテンシに差が出る。要するに「同じASMでも周辺のレジスタ/メモリ状況が変われば命令のホット度は変わる」。

- 根本原因と対策  
  根本はコンパイラが横断的に消せなかったRust抽象（関数ポインタ経由の処理）。これをよりコンパイラに最適化しやすい形に書き換えることで解決（著者はPRで修正）。具体的には抽象を簡潔にしインライン可能にする、あるいは直接的なextern "C"境界にして最適化を促す、といったアプローチ。

- 注意点  
  著者の実験はMacBook上で行われたためツールに制約があり、プラットフォーム差やプロファイラの性質による誤差可能性は残る。

## 実践ポイント
- サンプリングプロファイラを命令単位で見る  
  samply の asm view のように命令ごとのサンプルを比較すると、微妙な性能差の原因をピンポイントで見つけやすい。

- スタック/レジスタ割り当てを疑う  
  同じASMが遅い場合は周辺のスタック使用量やレジスタ割り当ての違いを疑う。生成されたLLVM IRやアセンブリを比較する。

- Rust側の抽象を見直す  
  関数ポインタや複雑な抽象が最適化の障害になっている場合は、よりコンパイラフレンドリーな形（単純化、#[inline]指定、ジェネリクスやextern "C"ラッパー、LTO有効化など）に書き換えてみる。

- 小さな差も無視しない  
  命令単位での差は全体の数%や実行時間で顕在化することがあるため、ホットパスは細かく見る。

## 引用元
- タイトル: Why is calling my asm function from Rust slower than calling it from C?  
- URL: https://ohadravid.github.io/posts/2025-12-rav1d-faster-asm/
