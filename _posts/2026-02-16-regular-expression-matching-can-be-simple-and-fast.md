---
layout: post
title: "Regular Expression Matching Can Be Simple And Fast (but is slow in Java, Perl, PHP, Python, Ruby, …) - 正規表現マッチングはシンプルで高速になり得る（ただし Java/Perl/PHP/Python/Ruby では遅い）"
date: 2026-02-16T04:36:37.541Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://swtch.com/~rsc/regexp/regexp1.html"
source_title: "Regular Expression Matching Can Be Simple And Fast"
source_id: 440549637
excerpt: "ReDoSを招く正規表現を見抜き、Thompson NFAで安全に高速化"
---

# Regular Expression Matching Can Be Simple And Fast (but is slow in Java, Perl, PHP, Python, Ruby, …) - 正規表現マッチングはシンプルで高速になり得る（ただし Java/Perl/PHP/Python/Ruby では遅い）
「その正規表現、知らずにアプリを遅くしていませんか？」——理論に基づく超速マッチング入門

## 要約
古典的な「Thompson の NFA」方式は、特定の実装（Perl/PCRE系のバックトラッキング）より桁違いに速く「常に線形時間」で動作する。誤ったパターン（特にネストした量指定やバックリファレンス）は爆発的な遅延（ReDoS）を招く。

## この記事を読むべき理由
日本のウェブサービスやログ処理で大量データを扱う開発者は、正規表現の選び方でパフォーマンスとセキュリティ（ReDoS）に大きな差が出るため、仕組みを理解して安全かつ高速に実装する価値が高い。

## 詳細解説
- 2種類の主流アルゴリズム
  - バックトラッキング方式（Perl・PCRE・Python 等）  
    - 分岐で「どちらか」を順に試す。最悪ケースで試行パス数が指数的に増え、短い文字列でも非常に遅くなる。
    - バックリファレンス（\1 等）を扱える反面、理論的には正規表現の外（非正規）であり計算量が爆発しやすい。
  - Thompson の NFA（複数状態同時シミュレーション）  
    - 正規表現を NFA に変換（各演算子ごとに状態を作る）し、入力文字ごとに「到達可能な状態集合」を更新する方法。ε遷移を含む構造を扱う。  
    - 入力長に対して線形時間（正規表現長に比例するオーバーヘッドはあるが、指数的増加は起きない）。古典的な grep/awk の多くはこの方式。
- 例（直感）  
  - 特定のパターン（ネストした ?/* や (a|aa){n} のようなもの）をバックトラッキングエンジンで処理すると、同じ入力を何度も（場合によっては指数回）読み返す。一方 NFA シミュレータは各入力文字を一度ずつ処理し、状態集合を更新するだけで済む。
- 理論と実装の関係  
  - Thompson の構成により正規表現長 m に対して最大で O(m) の状態数を作れる。マッチ処理は「各入力文字ごとに状態集合を進める」ため入力長 n に対して O(n·m) 程度（多くの実用場面では事実上線形）で安定する。
  - 現代言語がバックトラッキングを採る理由は機能性（キャプチャの扱い、Perl互換機能）や互換性が大きいが、性能上の危険がある。

## 日本市場との関連性
- Webアプリ／API／ログ処理で大量の文字列を扱う日本のサービスは、意図せずに「ReDoS（正規表現によるサービス拒否）」の脆弱性を招きやすい。外部入力に対して複雑な正規表現をそのまま使うと攻撃の対象になり得る。
- 既存のツール（grep, awk）や Google の RE2 など非バックトラッキング実装は、大量データ処理やセキュリティ要件のある場面で有利。

## 実践ポイント
- 危険なパターンを避ける：ネストした量指定（(a+)+ など）や過度の選択肢を含む正規表現は避ける。
- バックリファレンスに注意：必要なければ使わない。使うと爆発的コストの原因になる。
- エンジン選択：パフォーマンスや安全性が重要なら非バックトラッキング実装（例：RE2、POSIX/Thompson系のツール）を検討する。
- 防御策：外部入力を検証して長さを制限する、複雑なパターンは事前にベンチマーク／タイムアウトを設ける。
- テスト習慣：疑わしい正規表現は悪意ある入力を想定して負荷テスト（ReDoSテスト）を行う。

以上を踏まえ、まずは自分のコードで使っている正規表現をレビューし、必要に応じてエンジンの切替やパターンの書き換えを行ってください。
