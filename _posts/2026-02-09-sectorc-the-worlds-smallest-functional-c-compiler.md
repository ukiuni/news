---
layout: post
title: "SectorC: The world’s smallest functional C compiler - 世界最小の実用Cコンパイラ"
date: 2026-02-09T04:32:14.211Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://xorvoid.com/sectorc.html"
source_title: "xorvoid"
source_id: 407570969
excerpt: "512バイトのブートセクタに収まる実用CコンパイラSectorCの極限最適化技法と実機デモ"
---

# SectorC: The world’s smallest functional C compiler - 世界最小の実用Cコンパイラ
思わずニヤリとする「512バイトで動くCコンパイラ」の話 — 極限ミニマル工学の愉しみ

## 要約
x86-16アセンブリでブートセクタ（512バイト）に収まるCコンパイラ「SectorC」。完全なCではないが、実用的なサブセット（関数・グローバル変数・if/while・多種演算子・ポインタ・inline asm等）をサポートし、実際のデモ（VGA描画やPCスピーカー出力）まで動く。

## この記事を読むべき理由
極限まで小さくするための発想とテクニックは、組み込み・レトロPC趣味・コンパイラ入門の学習教材として学びが大きい。日本のローリソース環境や低レイヤ開発を志すエンジニアにとって、設計トレードオフの実例が詰まっている。

## 詳細解説
- 何を達成したか  
  SectorCはブートセクタに収まるコンパイラで、ソースをトークン化→パース→コード生成までを512バイト級で行う。出力はx86-16コードで、ランタイムと結合して実機やエミュレータ上で実行可能。

- 主要アイデアとトリック
  - Barely C（“空白区切り”C）  
    トークナイザを極端に単純化するため、空白で大きなトークン（mega-token）を取り扱える書き方を許容。これで通常の複雑な字句解析を回避。
  - atoi をハッシュ関数として使用  
    文字列→数値変換（atoi）の性質を利用してキーワード／識別子／整数を16ビットで扱い、識別子はハッシュで64K領域を直接参照。シンボルテーブルを簡素化。
  - バイトスレッド風の試行と断念  
    Forth的な「バイトでアドレス指定するガジェット列」も試したが、オーバーヘッドで効果が薄く断念。
  - ミニマイズ技巧（サイズ削減）  
    fall-throughの多用、tail-jumpでの呼び出し最適化、stosw/lodswの多用、ジャンプを短距離に収める、演算子→機械語のテーブル化（16bit token + 16bit codeペア）などでコードを圧縮。
  - 機能範囲（サポート）  
    ネスト可能なif/while、算術/ビット演算/比較/シフト、関数定義・再帰、*(int*) のような直接デリファレンス、asm リテラルによる低レイヤI/O、コメント（//, /* */）などをサポート。
  - 実行環境と例  
    ランタイム（Cで書かれた小さなlibと_start）を結合して実行。例としてVGAでサイン波アニメ、文字表示、PCスピーカーでの鳴動などがある。

- トレードオフ  
  サイズを優先するためエラーチェックや安全性はほぼ皆無。言語仕様は「ほぼC」だが書き方に制約があり、保守性は低い。

## 実践ポイント
- ソースを読む／試す：作者のGitHubやページからソースと例（sinwave, hello, twinkle）を落として、DOSBox/QEMUで動かしてみると学びが早い。  
- 学習ポイント：  
  - 字句解析の単純化（空白トークン化、ハッシュ化）を試すと、小規模言語設計の感覚が掴める。  
  - コードサイズ最適化（fall-through、短ジャンプ、テーブル駆動）を小さな例で実験するとアセンブリ最適化の勘所が身につく。  
- 応用想像：組み込みやブートローダ、レトロPC向けツールのプロトタイプ作成にヒントが得られる。

興味があれば元の実装（xorvoid/ SectorC）をクローンして、sinwaveの色や周波数をいじるところから改変してみてください。
