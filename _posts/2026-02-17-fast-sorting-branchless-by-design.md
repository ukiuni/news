---
layout: post
title: "Fast sorting, branchless by design - ブランチレス設計による高速ソート"
date: 2026-02-17T13:32:18.317Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://00f.net/2026/02/17/sorting-without-leaking-secrets/"
source_title: "Fast sorting, branchless by design - Frank DENIS random thoughts."
source_id: 892303964
excerpt: "Batcherとdjbsortで分岐ゼロ・SIMDを活用し機密データを高速かつ安全にソート"
image: "https://00f.net/favicon.ico"
---

# Fast sorting, branchless by design - ブランチレス設計による高速ソート
驚くほど速くて「秘密を漏らさない」ソート――分岐ゼロの設計がもたらす実用的な安全性と性能

## 要約
ソートを値に依存しない固定スケジュール（ソーティングネットワーク）で実装することで、タイミング側チャネルを防ぎつつ実用的な速度を出せる。Batcher のビトニック法や djbsort の SIMD / 分岐レス実装がその代表例だ。

## この記事を読むべき理由
機密データを扱う暗号実装（例：ポスト量子暗号）やサーバ／組み込み機器で、ソートによるタイミング漏洩が致命的になる場面が増えています。日本のサービスや組み込み市場でも、データ漏洩対策と性能の両立は現実的な課題です。

## 詳細解説
- なぜ普通のソートは漏れるか  
  クイックソートやマージソートは分岐やメモリアクセスがデータ依存で変わるため、実行時間・分岐パターンが入力によって変化し、観測者に情報を与える（タイミング側チャネル）。
- ソーティングネットワークの基本  
  ソーティングネットワークは「比較-交換（compare-and-swap）」の固定配線で構成され、比較順序が入力値に依存しない。これにより同一長さの配列なら常に同じ命令列・メモリアクセスになる。
- 古典的ネットワーク例  
  - バブルソートは比較スケジュールが固定なのでネットワークになり得るが、深さ・比較数が $O(n^2)$ で大規模には遅い。  
  - 奇偶転置ソートは同位相の比較が独立で並列化可能だが深さは $O(n)$。
- ビトニック／Batcher の手法  
  ビトニック合併器は長さ $n$ のビトニック列を $O(\log n)$ 層で合併可能。Batcher の再帰構成で全体をソートでき、全体の深さは $O(\log^2 n)$、比較数は $O(n\log^2 n)$。データ依存性を排して並列性を露出するため、GPU や SIMD と相性が良い。
- djbsort の工夫（実装上のポイント）  
  - トポロジは Batcher のネットワーク。  
  - ネイティブ数値型向け関数（sort）は SIMD の packed min/max を使う高速経路と、SIMD 未対応時のスカラー分岐レス経路を用意。  
  - 分岐レススカラーは差分を取り符号ビットを抽出してマスクを作り、XOR スワップで交換を行う（ブランチを生まない実装）。マスク生成は 0 - sign_bit による全ビット拡張を利用。  
  - ジェネリック版（sortWith）は、比較関数自体が定数時間であることが前提。比較がデータ依存なら漏れる。  
  - コンパイラ最適化で分岐レスコードが枝分かれに戻されるのを防ぐため、最適化バリア（例：asm volatile のダミー）を挟む。  
  - 浮動小数点は NaN や -0/+0 の扱いで通常の順序が定義されないため、ビットを整数として再解釈し順序を揃える（float→キー変換して整数ソート）という「useint」技法を用いる。
- アーキテクチャ面の注意  
  djbsort は x86/x86_64 と aarch64 での分岐レス min/max 削減を考慮しており、ARM 系（日本で多いモバイルや一部サーバ）でも最適経路が有効になる設計がされている。

## 実践ポイント
- 機密データを扱うコードでは「ソートも攻撃対象」と認識し、データ非依存なネットワークソートを検討する。  
- GPU や SIMD を使える環境ではビトニック／Batcher 系ソートが実用的。  
- 汎用ライブラリを使うなら、比較関数も含めて定数時間実装になっているか確認する（sortWith の比較が漏洩源になり得る）。  
- 実行対象アーキテクチャでの命令生成（packed min/max が本当に分岐レスか）をビルド後に確認し、必要ならアーキテクチャ固有のフラグやパッチを当てる。  
- 小規模配列ならキャッシュに乗る領域でバブル系のネットワークが十分速い場合もあるため、用途に応じて選ぶ。

短く言えば：セキュリティのために「分岐しない」ソートを選ぶと実用性を失わない。Batcher のビトニック構造と djbsort の SIMD／分岐レス工夫は、実務レベルで使える解です。
