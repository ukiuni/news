---
layout: post
title: "Test your square brackets - 角括弧テスト"
date: 2026-01-15T13:33:56.227Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://fluca1978.github.io/2025/12/10/testAndSquareBrackets.html"
source_title: "Test your square brackets! – Luca Ferrari – Open Source advocate, human being"
source_id: 46553556
excerpt: "[]」の実装差で生じるバグと移植性、[[...]]での安全対策を紹介"
---

# Test your square brackets - 角括弧テスト
思わず確認したくなる「[ ]」の正体 — シェルスクリプトで起きる小さな落とし穴と安全な書き方

## 要約
シェルの [ と test は歴史的に同じ機能を持つことが多いが、実体や振る舞いは環境によって異なる。特に [ を使う場合は末尾の ] の有無がエラーの原因になり得るので注意が必要。

## この記事を読むべき理由
- 初心者でもよく使う if 文の基本で思わぬバグを生むため、確実に理解しておくとデバッグ時間を大幅に短縮できる。
- 日本の現場でも Linux, macOS, 旧来の Unix（Solaris など）混在のケースがあり、移植性を意識したスクリプト作成が重要になる。

## 詳細解説
- test は元来のコマンドで、ファイル有無や文字列比較などを行う実行ファイル（/bin/test 等）。その短縮形として [ が用いられることがあるが、実は [ もコマンドであり、呼び出し方によって末尾に ] を必要とする実装になっている。
- 実装差：一部の BSD 系では /bin/test と /bin/[ が同一ファイルへのリンクになっていることがあり、同じ挙動を示す。一方、GNU 系では同じソースから別ビルドされた別実行ファイルとして存在し、細かい挙動やオプション解釈が異なる場合がある。
- 仕様上、[ をコマンドとして使う場合は最後の引数が ] でなければ「missing ']'」のようなエラーを出す実装がある。これはシェルがチェックしているのではなく、[ コマンド自身が引数を確認しているため。
- 現代の Bash には [[ ... ]] というキーワード（ビルトイン）があり、より柔軟で安全。単純な条件判定にはこちらを推奨する場面も多い。

簡単な例（正しい書き方）:
```bash
#!/bin/bash
file="/path/to/file"
if [ -f "$file" ]; then
  echo "ファイルが存在します"
fi
```

間違いやすい例（末尾の ] を忘れるとエラー）:
```bash
# NG: 最後の ] を忘れているとエラーになる実装がある
if [ -f "$file" ; then
  echo "この行は実行されないかもしれない"
fi
```

より安全な Bash の書き方（推奨）:
```bash
#!/bin/bash
if [[ -f "$file" ]]; then
  echo "ファイルが存在します（[[ を使用）"
fi
```

## 実践ポイント
- 基本ルール：条件式内の変数は常にダブルクォートする（"$var"）。空白や特殊文字での誤動作を防げる。
- 移植性が必要なら POSIX 準拠の [ ... ]／test を意識する。ただし古い Bourne shell では挙動が異なることがあるため、対象環境を確認する。
- Bash 固有の機能を使えるなら [[ ... ]] を使うと安全（ワード分割やパターンマッチの扱いが優秀）。
- CI や複数環境でスクリプトを動かす場合は shebang とシェルのバージョンを明示し、簡単なテストスイート（ファイル存在チェックや引数欠如時の挙動確認）を用意する。

短いチェックリスト
- [ ] 変数は必ず "..." で囲んでいるか
- [ ] [ を使うなら末尾の ] を忘れていないか
- [ ] スクリプトの実行環境（/bin/sh が何を指すか）を把握しているか

以上を守れば、普段何気なく書いている if 文でのトラブルをかなり防げる。
