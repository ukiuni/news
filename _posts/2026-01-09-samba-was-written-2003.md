---
layout: post
title: "Samba Was Written (2003) - Sambaはこうして書かれた"
date: 2026-01-09T13:29:49.045Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://download.samba.org/pub/tridge/misc/french_cafe.txt"
source_title: "Samba Was Written (2003)"
source_id: 46486545
excerpt: "Sambaの逆解析手法：聞き・誤操作・自動探索でSMB互換を12年で解明"
---

# Samba Was Written (2003) - Sambaはこうして書かれた
サーバーの会話を「聞き」「挑発し」「自動で探る」──Sambaが築いたリバースエンジニアリングの教科書

## 要約
Sambaの作者は公開仕様＋ネットワークスニッフィング＋意図的な誤操作（エラー誘発）＋プロトコルスキャナ（自動探索）＋差分比較の組合せで、12年かけてSMB/CIFSプロトコルを解明していった。

## この記事を読むべき理由
日本企業ではWindowsとLinuxが混在する環境やNAS連携が今も多く、SMB/CIFSの互換やトラブル対応は現場で重要です。Samba開発の手法を知れば、プロトコル理解の進め方やテスト手法が学べ、実務での調査・検証力が高まります。

## 詳細解説
- 背景
  - SambaはWindowsのファイル共有プロトコル（SMB/CIFS）を再実装したOSSで、相互運用性を確保するためにリバースエンジニアリングが不可欠でした。Andrew Tridgellが示した手法は、プロトコル解析の体系的な教科書と言えます。
- Method 1：既存の仕様を読む
  - まず公開されている仕様書（例：draft-leach-cifs-v1-spec-02.txt など）を収集して出発点とする。仕様は不完全・不正確な箇所があるが、有益な足がかりになる。
- Method 2：フレンチカフェ技法（受動観察）
  - ネットワークスニッファで実際のクライアントとサーバーの会話を「聞く」。Wiresharkやtcpdumpでパケットを取り、送られているフィールドと意味を推測していく。まずはファイル名、サイズ、タイムスタンプなど頻出フィールドから学ぶ。
- Method 3：誓いの言葉（能動的な誤操作）とプロトコルスキャナ（自動探索）
  - エラー誘発：存在しないファイルアクセス等で返るエラーコードを観察し、エラー時の挙動を把握する。
  - プロトコルスキャナ：あるフィールドにあり得る値を片っ端から送ってサーバーの応答を解析する（コマンドワードの総当たり、入力長の探索、非空データの投入）。応答が変わる境界を見つけ、どの組合せで成功するかを特定して「新しい命令」を発見する。
  - 発見した有効なリクエストについては、続けて既知の問い合わせを送り、状態変化（ファイルサイズや名前の変化など）を確認して意味を決定する。
- Method 4：差分手法（差分テスト）
  - 自分の実装（仮想のウェイター）と実サーバーに同じシーケンスを送って応答を比較する。差が出た最小のフレーズを切り分けて原因を突き止め、修正→再試験を繰り返すことで動作一致を目指す。
- 全体像
  - これらを組み合わせ、継続的に自動化と観察を行うことで、Sambaは長期間かけて高い互換性を築いた。

## 実践ポイント
1. 学習の出発点は公式・公開仕様とSambaのソース
   - samba.orgの仕様・ソースを読む。まずは高レベルの流れをつかむ。
2. 安全なラボ環境で「聞く」「壊す」「試す」
   - Wireshark/tcpdumpでパケットを取得。実ネットワークでの解析や攻撃に当たる行為は法的・倫理的に問題になるため、必ずVMや隔離ネットワークで行う。
3. ツールを活用する
   - パケットキャプチャ（Wireshark）、SMBクライアント（smbclient等）、プロトコル解析用スクリプト（scapyやboofuzzなどのファジングライブラリ）が役に立つ。
4. 小さな実験で観察を繰り返す
   - まずは「存在しないファイルを開く」など単純な誤操作で返るエラーを調べ、そこからコマンドの振る舞いを推定する。
5. 差分テスト／回帰テストを自動化する
   - 実サーバーと自実装の応答差を自動検出し、最小差分を切り分けるスクリプトを用意することで解析効率が劇的に上がる。
6. 文書化する習慣
   - 観察結果（どのバイト列でどう変わったか）は必ず記録し、後で検証・共有できるようにする。

最後に一言：解析は「忍耐」と「自動化」が鍵です。Sambaの歴史は、地道な観察と試行錯誤を自動化で増幅した好例で、プロトコルに向き合うすべての人に参考になります。
