---
layout: post
title: "pf: Make af-to less magical - af-to を「魔法扱いしない」へ"
date: 2026-01-16T10:14:31.962Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://undeadly.org/cgi?action=article;sid=20260116085115"
source_title: "pf: make af-to less magical"
source_id: 46644541
excerpt: "OpenBSD pfのaf-to挙動を簡素化、設定とデバッグが劇的に楽に"
---

# pf: Make af-to less magical - af-to を「魔法扱いしない」へ
OpenBSDのpfでIPv4↔IPv6アドレスファミリ変換（af-to）が動作の特例になっていた振る舞いを簡素化するパッチが提案された話

魅力的なタイトル: OpenBSDのpfが「魔法」を捨てる — af-toを素直にして設定とデバッグを楽にする修正案

## 要約
OpenBSDのpfで使われてきたaf-to（アドレスファミリ間変換）が特別扱いされていた挙動を、転送強制をやめて他のルールと同じ流れに統合するパッチが提案された。結果としてコードが単純化され、ローカルスタック経由の変換（pass out）も自然に扱えるようになるが、運用側は追加のアウトゴーイングルールが必要になる。

## この記事を読むべき理由
日本でもIPv4/IPv6の混在環境は現場レベルで頻出する。自宅ルータや企業の境界ファイアウォールにOpenBSDを使う場面、あるいは移行期の検証をする際、af-toの挙動が分かりにくいと運用ミスやデバッグの時間が増える。本修正は現場のルール設計とデバッグをシンプルにする可能性があるため、OpenBSDでネットワークを扱う技術者は注目すべき。

## 詳細解説
- 背景：IPv4とIPv6は直接互換でないため、ネットワーク間で通信を橋渡しする「アドレスファミリ翻訳（af-to）」が必要になる。OpenBSDのpfにはaf-toオプションがあり、古くから特殊処理で実装されてきた。
- 旧挙動の問題点：
  1. af-toは「pass in」ルールでのみ動作（incomingに限定）。
  2. 翻訳されたパケットを必ず転送（forward）するよう強制していた。
  結果として、af-to接続はファイアウォール上で通常の転送接続と異なり「片側だけの状態（state）」しか作られず、多数の特例処理がコードに入っていた。
- 提案された変更：
  - af-toが転送を強制しないようにする。具体的には、ip_input が pf_test を呼んだあと、翻訳パケットを ip6_forward ではなく ip6_input 側に流すようにする。
  - これにより、翻訳後のパケットはローカルの TCP/UDP スタックに渡され、rdr-to（リダイレクト）と同様の扱いが可能になる。
  - 入出力側で二重に pf_test を実行してしまう問題を回避するため、既存の mbuf 上の状態管理（PF_TAG_GENERATED / PF_TAG_REROUTE）を ip_input/ip6_input 側にも拡張して処理する。
- 効果：
  - pass out を用いたローカルスタック発のアドレスファミリ変換が「Just Works」になる。
  - コードの特例処理が減り、実装がシンプルかつメンテナブルになる。
- 運用上の影響（デメリット）：
  - af-toが転送を強制しなくなるため、従来は1つの pass in で済んでいたケースでも、アウトゴーイングを許可する pass out ルールを明示的に追加する必要がある。
  - 例（旧）：1ルールで動いていたものが、今後は out ルールも追加する必要がある。
- テスト状況と要望：提案者は最小限のテストしか行っておらず、実運用でaf-toを使っている人からのフィードバックを求めている（OpenBSD tech@ のスレッドで議論中）。

## 実践ポイント
- 今すぐ試す手順（検証環境で推奨）：
  1. OpenBSD-current かパッチを入れたビルド環境を用意する。
  2. 現行の af-to を使う pf ルールを用意し、動作を確認する（tcpdump / pflog / pfctl -s state で状態を観察）。
  3. 提案パッチ適用後、同じトラフィックを流して差分を確認。翻訳後にローカルスタックへ流れているか、state の数や向きが変わるかを見る。
- ルール変更の注意点：
  - 今後はアウトゴーイングを明示的に許可する必要があるため、以下のような pass out ルールを追加すること（例）：
```pf
pass in on em0 inet proto udp from 192.168.1.1 to 192.168.2.1 af-to from 2407::1 to 2407:2::1
pass out on em0 inet6 proto udp from 2407::1 to 2407:2::1
```
- 検証ポイント：
  - pfctl -s state で接続状態の左右（双方向のstate）がどう変わるか確認する。
  - tcpdump で翻訳前後のパケットフローを追い、期待どおり ip_input → ip6_input の経路になっているか確認する。
- フィードバックの出し方：
  - 実運用での影響（ルールの書き換えが増えるか、既存セットアップで不具合が出るか）を簡潔にまとめて tech@ のスレッドに書き込むと議論に貢献できる。

この変更は、運用側で多少のルール追加を伴う代わりに、実装と挙動が直感的になりメンテナンス負荷が下がる可能性が高い。OpenBSDでIPv4/IPv6混在環境を扱う現場では、早めに検証しておくと有用である。
