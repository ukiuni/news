---
layout: post
title: "From specification to stress test: a weekend with Claude - 仕様からストレステストへ：Claudeと過ごした週末"
date: 2026-02-12T10:10:25.097Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://www.juxt.pro/blog/from-specification-to-stress-test/"
source_title: "From specification to stress test: a weekend with Claude"
source_id: 46986496
excerpt: "仕様を共通言語にClaudeで週末に分散BFTを実装し10,000RPS達成"
image: "https://www.juxt.pro/_astro/from-specification-to-stress-test.358f8c14_KfojK.webp"
---

# From specification to stress test: a weekend with Claude - 仕様からストレステストへ：Claudeと過ごした週末

魅力的なタイトル: LLMだけで分散BFTシステムが動いた週末――仕様駆動で10,000 RPSを達成した実録

## 要約
週末を使って、Alliumという振る舞い仕様言語を軸にClaude（LLM）と会話しながら分散イベントソーシング＋Byzantine fault detectionのシステムを設計・実装・負荷検証し、短時間で高スループット（最終的に10,000 RPS、p99 < 100ms）と耐障害性を達成した事例。

## この記事を読むべき理由
仕様を「人とLLMの共通言語」にして設計を進める手法は、日本のスタートアップやSIerが短期間で堅牢な分散システムを作る際に即応用可能。実装だけでなく境界設計、検証、ボトルネック探索までLLMを実戦投入した過程は学びが多い。

## 詳細解説
- アプローチの核：Alliumという「振る舞い仕様言語」を用意。TLA+と文章の中間くらいの粒度で、システム振る舞い（例：idempotencyのTTLでエントリ削除）をルールで明記し、LLMに「これに従って実装して」と指示する。
- 仕様の構造：rule（振る舞い）に加え、guidance（実装ヒント＝データ構造やスケーリング想定）とresolved-question（設計の決着）を用意してLLMの選択肢を適切に狭める。
- 自律実装の結果：Claudeに仕様を与えて50分で4,749行のKotlinと103個の単体テストが生成。主要コンポーネント名は Usher（Kafka消费）、Arbiter（イベント評価）、Clerk（BFT同意）、Registrar（キャッシュ）、Ledger（永続化）、Warden（重複除去）。
- 境界問題の発見：最初の負荷テストで全リクエスト失敗。個々のコンポーネントは仕様通りだったが、ランタイム上でのインスタンス間接続（federation）が配線されておらず、境界（integration）で落ちた。仕様に「起動順序やフェデレーション接続」を追加して一件解決。
- 性能改善ループ：目標は5,000 RPSでp99 < 100ms。Claudeが繰り返しプロファイル→修正→負荷測定を行い、まずは大きなボトルネックを潰してp99を数秒から数百ミリ秒へ短縮。
- エージェントチームの活用：単一の最適化ループで頭打ちになったところで、複数の専門家エージェント（メモリ/ロック/アルゴリズム専門）を並列で走らせ、27の低レイヤ最適化を発見・適用。p99が157ms→25msに。
- 環境依存の罠：さらに10,000 RPSに挑戦した際、Gatlingの外部からの計測ではp99が上がっていたが、サーバ側計測は問題なし。原因はDocker Desktopのユーザ空間ポートフォワーディング（gvproxy）。負荷生成をコンテナ内部ネットワークに移すことで実測のp99は29ms、最終的に10,000 RPSでp99 < 100msを達成。
- 正しさの検証：性能だけでなく「障害下でも正しいか」をchaosやクラッシュ復旧シナリオで検証し、仕様主導でバグを発見・修正していった点が重要。

## 実践ポイント
- 仕様ファースト：振る舞いを仕様（Alliumのような形式）で明確化すると、LLMが一貫した実装を出しやすい。
- guidance／resolvedで実装余地を制御：データ構造や許容値を明示してLLMの選択ミスを減らす。
- 境界設計を明文化：コンポーネント間の起動シーケンスや接続責任は仕様で明確に。統合の「落とし穴」を事前に潰す。
- 並列査定（エージェントチーム）：性能探索は複数の視点で同時に調べると効率が跳ね上がる。
- 計測環境を疑え：ローカルDockerのプロキシやネットワーク経路で実際のレイテンシが歪むことがある。負荷生成は可能ならアプリケーションと同一ネットワーク/ノードで行う。
- テストの自動化：単体・統合・負荷・障害シナリオを自動化して仕様と照合するワークフローを作る。

――短時間で実用級の分散システムを作った事例は、設計の「言語化」とLLMの長所（反復実装・探索）を組み合わせれば、日本のプロダクト開発でも短納期かつ高品質での実装が現実的になることを示している。
