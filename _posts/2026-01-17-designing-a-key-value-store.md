---
layout: post
title: "Designing A Key-Value Store - キー・バリュー・ストアの設計"
date: 2026-01-17T17:44:02.177Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://yusufaytas.com/designing-a-key-value-store/"
source_title: "Designing A Key-Value Store - Yusuf Aytas"
source_id: 424408219
excerpt: "面接で刺さる実践指南：要件から容量・レイテンシ・運用を数値で解き明かすキー・バリュー設計"
image: "https://yusufaytas.com/wp-content/uploads/2021/12/key-value-store-usage-1024x206.jpg"
---

# Designing A Key-Value Store - キー・バリュー・ストアの設計
クリックしたくなるタイトル: 面接で刺さる「実用的」キー・バリュー・ストア設計 — 要件から運用までの最短ルート

## 要約
面接や実運用で問われる「キー・バリュー・ストア設計」を、要件定義→容量算出→レイテンシ設計→アーキテクチャ判断まで実例ベースで整理した記事。

## この記事を読むべき理由
日本のエンジニアや転職志望者が、よく出る設計問題を「実務で使える感覚」で素早く理解できる。特に面接での問い方・答え方、現場での現実的なトレードオフが掴める。

## 詳細解説
1) まずストーリーを作る  
- 何のためのストアか（例：ユーザー状態、ランキング用特徴量、認可情報など）を一文で説明する習慣をつける。これが設計の軸になる。

2) 機能要件（シンプルに）  
- Get(key) と Put(key, value) のみ。スキャン・トランザクション・セカンダリインデックス・削除は除外（面接用に意図的に制約）。TTLや削除は実運用で要検討だがここでは外す。

3) 非機能要件（設計を左右する）  
- 例：総データ量 4 TB、目標 P99 レイテンシ 20 ms、スループット 100,000 req/s、平均キー 64 B、平均値 1 KB、読書比率 90:10。  
- これらを元に「メモリ優先」「ディスクは耐久化用に非経路化」などの方針が決まる。

4) 背筋を通す計算（バック・オブ・ナプキン）  
- データ量換算：
$$4\ \text{TB} = 4 \times 1024\ \text{GB} = 4096\ \text{GB}$$  
- 仮に1台あたり 64 GB RAM で、運用に余裕を見て 50% をデータ用とすると可用 RAM は 32 GB。  
$$\text{必要ノード数} \approx \frac{4096}{32} \approx 128\ \text{台}$$  
- 複製係数 RF=3 を入れると実質は約 $128 \times 3 = 384$ 台相当の容量を見積もる必要がある。

5) スループットと負荷分散の感覚  
- クライアント要求 100k req/s、RF=3 ならレプリカ側での総オペレーションは約 $100{,}000 \times 3 = 300{,}000$ ops/s。  
- 384 台に分散するとノードあたり約 $ \sim800$ ops/s と CPU 的には余裕。課題は P99 とホットスポット（分散とネットワーク経路）になる。

6) レイテンシ設計の要点  
- P99=20 ms は厳しいためディスク経路は危険。実務的には「読み取りはメモリ優先、耐久化は WAL とスナップショットで非同期に行う」が現実的。  
- レイテンシ構成要素：クライアント→LB→コーディネータ→レプリカ、ネットワーク遅延、キューイング、GC（マネージド言語の場合）。

7) ルーティング／サービス形態の選択肢  
- クライアントサイドルーティング：クライアントがシャード計算して直接ノードへ。ホップは少ないがクライアント側のライブラリ運用・言語対応が負担。  
- サーバーサイドルーティング（推奨）：安定した API エンドポイントへ投げ、内部でコーディネータがシャード選定→転送。ホップが増えるが運用性と互換性が高い。コーディネータはステートレスにするのが楽。

8) レプリケーションと一貫性  
- 実用的には RF=3、Quorum 読み書き（例：R=2, W=2）がよく使われる。これで可用性と整合性のバランスが取れる。書き込みは WAL、スナップショット、復旧時 WAL リプレイ。読み取りパスにディスクを入れない。

9) 障害ドメインと運用上の決定  
- 単一リージョン＋複数 AZ がデフォルト想定。マルチリージョンにするとレイテンシ制約やコンフリクト解決の設計が別次元に変わる。

## 実践ポイント
- 要件を最初に数値で固める：データ量・レイテンシ（P99で指定）・スループット・読み書き比率は必須で確認。  
- 面接では「まず一文のユースケース」を述べると差がつく（ビジネス意識を示せる）。  
- バックオブナプキンでノード数や負荷分散感覚を示す：計算過程と仮定を明示すること。  
- レイテンシ重視なら「メモリ主軸、ディスクは非同期耐久化」。P99 を守る設計を優先する。  
- ルーティングは運用性重視でサーバーサイド推奨。コーディネータはステートレスに。  
- ホットキー対策（キャッシュ、再シャーディング、リレイなど）と監視（P99 細分化メトリクス）は必須。  
- 「余計な機能を勝手に付けない」こと（YAGNI）。試験問題と実問題の境界を明確にする。

以上を踏まえ、面接やプロトタイプ設計では「要件を数値で固め、簡潔なアーキテクチャ方針（メモリ中心、非同期耐久化、サーバー側ルーティング）を示し、バックオブナプキンの計算で妥当性を説明する」ことが最短で説得力を得られる方法になる。
