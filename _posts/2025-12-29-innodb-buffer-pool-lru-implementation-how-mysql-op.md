---
layout: post
title: "InnoDB Buffer Pool LRU Implementation: How MySQL Optimizes Memory Management"
date: 2025-12-29T23:32:40.348Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://shbhmrzd.github.io/databases/mysql/innodb/2025/12/18/innodb-lru-buffer-pool-management.html"
source_title: "InnoDB Buffer Pool LRU Implementation: How MySQL Optimizes Memory Management | Shubham Raizada’s Blog"
source_id: 436277511
excerpt: "InnoDBの中間挿入と遅延昇格でフルスキャン時のキャッシュ崩壊を防ぎ、性能安定化の設定法を解説"
---

# フルテーブルスキャンで“キャッシュ崩壊”しない秘策 — InnoDBのLRUはこう動く

## 要約
InnoDBのバッファプールは単純なLRUではなく「新旧2層＋中間挿入＋遅延昇格」でフルスキャンや一時的なアクセスでホットデータを追い出さない仕組みを採用している。適切な設定でキャッシュ効率を大幅に改善できる。

## この記事を読むべき理由
データベースのレスポンス改善は多くの日本企業で重要課題です。特に大規模データや定期的なフルテーブルスキャンがある環境では、InnoDBのLRU挙動を理解し、設定を調整することで予期せぬパフォーマンス低下を防げます。

## 詳細解説
- バッファプールの役割  
  - ディスクI/Oを減らすためにテーブル・インデックスページ（通常1ページ約16KB）をメモリにキャッシュする領域。専用DBでは物理メモリの約80%を割り当てるのが一般的。

- 単純LRUの問題点  
  - フルテーブルスキャンで大量ページが次々に先頭へ入ると、本当に必要なホットページが押し出され、キャッシュが「トラッシュ」されてしまう。

- InnoDBの改良版LRU（ポイント）  
  1. 二層構成：LRUリストを論理的に「new（新）」と「old（古）」の2つに分ける。おおよそ上位5/8がnew、下位3/8がoldになる。  
  2. 中間挿入：新しく読み込まれたページはリスト先頭ではなくoldサブリストの先頭（リスト中間付近）に挿入される。  
  3. 遅延昇格：同じページが再アクセスされ、かつ一定条件（経過時間など）を満たした場合にのみnewサブリストへ昇格する。  
  4. oldの限定サイズ：old領域が限定されているため、大量のスキャンは主にold内でチューニングされ、new側（ホットワーキングセット）は保護される。  
  5. エビクション：バッファが逼迫したとき、oldの末尾に到達したページから優先的に追い出されるため、スキャンで読み込まれた一時的なページが先に消える。

- 挙動の効果  
  - フルスキャンやバルクロードにより一時的に読み込まれたページは「検疫（quarantine）」されたold領域で回転し、ホットページはnew領域に残る。結果としてキャッシュの有効活用が維持される。

## 実践ポイント
- バッファプールサイズを適切に設定する  
  - innodb_buffer_pool_sizeは可能なら物理RAMの60–80%を目安に。OSスワップを起こさないように注意する。

- old/newの比や遅延昇格の調整  
  - old領域割合: innodb_old_blocks_pct（デフォルト約37% = 3/8相当）をワークロードに合わせて微調整。  
  - 昇格遅延: innodb_old_blocks_timeで、読み込んでから昇格が許される最短時間を指定（短すぎるとスキャンが昇格してしまう、長すぎると本当にホットなページの昇格が遅れる）。

- フルスキャン対策の運用上の工夫  
  - 大量データ取り出しはチャンク処理やページングで行い、一度に大量のページを流し込まない。  
  - ETLや分析ジョブはバッチ時間を分散させる、または専用のレポート用レプリカで実行する。

- モニタリングする指標  
  - バッファプールヒット率、読み込み回数（pages read）、innodb_buffer_pool_pages_dirtyやfree_pagesの推移。  
  - フルスキャン発生時にold/newの入れ替わりやエビクションが増えていないかを確認。

- 大規模環境での追加設定  
  - バッファプールが大きい場合はinnodb_buffer_pool_instancesを増やして同時性を改善。  
  - バッファプールのダンプ/ロード機能で再起動後のウォームアップを短縮する。

まとめ：InnoDBの「中間挿入＋遅延昇格」戦略は、簡単なチューニングで実運用の安定性を高められる。特に日本の企業で分析クエリとOLTPが混在する場合、上記のポイントを確認しておくだけで突発的なレスポンス低下を防げます。
