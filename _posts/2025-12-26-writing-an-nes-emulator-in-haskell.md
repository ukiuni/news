---
layout: post
title: "Writing an NES emulator in Haskell"
date: 2025-12-26T08:10:58.479Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://arthi-chaud.github.io/posts/funes/"
source_title: "Writing an NES emulator in Haskell"
source_id: 1158045137
excerpt: "HaskellでNESを再現し、関数型設計で性能と実装手法を探る挑戦記"
---

# HaskellでNESをエミュレートする意味 — FuNesが示す「関数型でハードを表現する」挑戦

## 要約
Haskellで書かれたNESエミュレータ「FuNes」の試みは、関数型パラダイムが古典的なハードウェアの振る舞いをどうモデル化できるかを検証する実験であり、実用的なフレームレートを目指しつつ設計・最適化のトレードオフを明らかにしている。

## この記事を読むべき理由
日本のゲーム開発者やシステム寄りのエンジニアにとって、関数型言語で「状態と副作用の濃い」古いハードをどう扱うかは設計知見として有益。Haskell流の設計・最適化手法は、組込みや性能が問われるソフトウェアでも応用できる。

## 詳細解説
- NESの主要コンポーネント  
  - CPU：命令を実行する中心。プログラムカウンタと少数のレジスタを持つ。  
  - Bus：アドレスに応じてCPU／PPU／カートリッジ等への読み書きを仲介する。  
  - PPU：背景・スプライト描画とスクロールを担当。独自のレジスタとVRAMを持つ。  
  - APU：音源を生成（多くの実装ではCPUから独立したモジュールとして扱う）。  
  - Joypad／Cartridge：専用アドレス空間でCPUとやり取り。  
  これらは割り込みやDMAのように互いに副作用を及ぼし合う（例：PPUやAPUのVRAM転送でCPUが数サイクル停止する等）。

- Haskellでの設計上の論点  
  - 純粋関数型とハードウェアの「逐次的・状態的」振る舞いのギャップをどう埋めるかが中心問題。StateモナドやIO/STモナド、ミュータブル配列を適所で用いて「モデルの明確さ」と「実行効率」を両立させる設計が鍵となる。  
  - メモリ管理が高レベルなHaskellでも、実行速度確保のためにヒープ割当を減らす工夫（厳格化、アンボックス、Mutable Vector/ByteString、参照透過性を崩さない最小限の副作用設計）が必要になる。  
  - Busや各デバイスを明確な境界でモジュール化し、CPUのクロック駆動／PPUのスキャンラインタイミング／APUのサンプリングを整合させる設計パターンが有効。

- 性能と目標  
  - 研究問いは「関数型が妨げになるか、助けになるか」「少なくとも25fps程度のフレームレートを達成できるか」。FuNesは完全互換を目指すのではなく、代表的なタイトル（Super Mario Bros.、Pac-Man）を動かす実装を目標にしている。  
  - 実務的にはプロファイリング（GHCツール）、ホットパスの最適化、ミュータブル構造の選択がパフォーマンス改善に直結する。

## 実践ポイント
- 入門順序：まずCPU（6502相当）のフェッチ・デコード・実行を実装 → Busを介したメモリマップ → PPUの最小実装（背景＋スプライト単純描画）→ APU／入出力。段階的に動作確認を行う。  
- テストと可視化：既知のROM／テストカートリッジ（nesdevのテストROM等）で逐次検証。PPU周りは可視化ログを出して状態を確認するとデバッグが早い。  
- Haskellでの実装技術：State/IO/STの使い分け、mutable Vector/ByteStringで大きなバッファを扱う、必要箇所だけ厳格化する。GHCプロファイラで割当やGCを観察する。  
- 既存リソースを活用：nesdev.orgや「Writing an NES Emulator in Rust」などの解説はアーキテクチャ理解に有用。Haskell側は既存のライブラリ（SDL2で出力・音声）を組み合わせると実装工数を削減できる。  
- 小さく始めて繰り返す：100%互換を最初から目指さず、動くものを早く作ってから互換性や最適化を段階的に追加する。

## 引用元
- タイトル: Writing an NES emulator in Haskell  
- URL: https://arthi-chaud.github.io/posts/funes/
