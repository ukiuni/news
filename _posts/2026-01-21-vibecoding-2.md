---
layout: post
title: "Vibecoding #2 - バイブコーディング #2"
date: 2026-01-21T13:26:00.347Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://matklad.github.io/2026/01/20/vibecoding-2.html"
source_title: "Vibecoding #2"
source_id: 46704943
excerpt: "AIと小型ツールで6台クラスタを一発同期・同時実行する実践ワークフロー"
---

# Vibecoding #2 - バイブコーディング #2
6台のクラスタを一発で回す方法 — AIと小さなツール群で作る「box」ワークフロー

## 要約
ローカルの開発状態をそのまま複数のクラウドVM上に反映して、同時にコマンドを実行できる小さなツール「box」を作った記録。AI（ChatGPT / Claude）を使った仕様設計と実装分担がポイント。

## この記事を読むべき理由
実機クラスターでパフォーマンス検証やレプリカ動作を確かめたい日本のエンジニアにとって、手作業でVMを6台〜立てて同期・実行する手間を激減させる実践的なヒントが得られるため。特にスタートアップやSRE、分散システムを扱うチームに有用。

## 詳細解説
- 背景と課題  
  TigerBeetleのような分散DBを本番に近い環境で試すには、複数台のVMを用意して同時に負荷をかける必要がある。手作業や単純なssh運用では編集と実行の状態が分かれ、6台規模になると運用が破綻しがち。

- 使ったアイデア源  
  1) rsyscall：ローカルのsyscall風APIをネットワーク越しに拡張し、遠隔操作を「ローカルの延長」として扱う考え。  
  2) remote-sync / remote-run（Peter Bourgonの手法）：ローカルのディレクトリをリモートに同期して、同じコマンド体系で実行するという精神。  
  3) dax（JSでのシェルスクリプト支援）：テンプレートリテラルで安全にコマンドを組み立て、async/awaitで並列処理を扱う。

- 実装の核：boxスクリプト  
  deno + TypeScriptで「box」を作り、VM作成(create)、一覧(list)、同期(sync)、同時実行(run)、破棄(destroy)を提供。例：box create 3 → IP取得 → box sync 0,1,2 → box run 0,1,2 ./zig/zig build ... のようにワンフローで進められる。内側ではAWSのスポットインスタンス作成やuser-data、タグ付け、SSHでのrsync／コマンド実行を組み合わせる。

- AIとの協働プロセス  
  最初に高レベルな要望を短い英文で書き、ChatGPTで詳細仕様に拡張→Claudeに実装補助を依頼する流れ。AIはクラウドAPIの細かいコマンドやJSONオプション（例：スポット用のInstanceMarketOptions）生成で有用。ただし「一発で全部やらせる」よりも、手元でスケルトン（CLI構造やmain/instance分離）を用意してAIに部分実装を任せる「段階的補完」のほうが保守性・理解性が高い。

- 注意点と学び  
  - 名前付け（0,1,2）の連番設計は操作性と衝突回避に有利。  
  - コスト管理と自動実行のリスク（AIに勝手にAWSを叩かせない）。  
  - 実装哲学：AIは実作業と繰り返し改良が得意。設計の骨格は人が作っておくと良い。  
  - 実運用の簡潔な仕様（例：8時間後自動停止）で十分なケースが多い。

## 実践ポイント
- 小さく始める：まずCLIスケルトン（create/list/sync/run/destroy）だけ自分で作る。AIに関数本体を補完させる。
- 同期→実行のワークフローを採用：ローカル編集は一箇所、実行先は複数に切り替え可能にする。
- ツール候補：rsyscall（概念）、dax（JSシェル）、deno+TypeScriptを検討。まずはローカルで模擬してからクラウド投入。
- 命名とID戦略：連番（0,1,2…）で扱うと指定が楽で衝突管理もしやすい。
- 安全対策：AIにクラウド操作を任せる場合は、コストと権限を厳しく制限したテストアカウントで段階的に実行する。
- 直ちに使えるコマンド例（イメージ）：
  - box create 3
  - box sync 0,1,2
  - box run 0,1,2 ./build-script
  - box destroy 0,1,2

以上を踏まえれば、複数台を「ただの並列ターミナル」ではなく、同じプロジェクト状態を共有する実行クラスタとして扱えるようになる。日本の現場でも、手間を減らしつつ本番に近い検証を短時間で回す助けになるはずだ。
