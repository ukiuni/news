---
  layout: post
  title: "Decorative Cryptography - 装飾的暗号"
  date: 2026-01-05T09:09:29.318Z
  categories: [tech, world-news]
  tags: [tech-news, japan]
  source_url: "https://www.dlp.rip/decorative-cryptography"
  source_title: "Decorative Cryptography | Chris Fenner’s Personal Blog"
  source_id: 46496494
  excerpt: "TPMの暗号が鍵管理欠陥で破られ、物理インターポーザ攻撃で測定起動が改竄され得る実例と対策を暴露"
  ---

# Decorative Cryptography - 装飾的暗号
TPMの「暗号で安心」が招く落とし穴 — 鍵管理を無視した“装飾的”な保護

## 要約
LinuxのTCG_TPM2_HMAC機能は、TPMバス上の傍受や改ざんを防ごうとするが、鍵管理と信頼の連鎖を逆転させる実装欠陥により、活発な物理インターポーザ（バス上で読書きする攻撃者）に容易に破られる可能性がある。暗号が問題を解決するのではなく、鍵管理問題に置き換えているだけだ、という警鐘だ。

## この記事を読むべき理由
日本のインフラやエンタープライズ環境でもTPMはディスク暗号や測定起動で広く使われており、BMC・保守端末・物理アクセスが現実的な攻撃ベクトルになる。TPM周りの「安全そうに見える」機能が実態では誤解を生み、信頼を損なうリスクを具体的に理解する必要がある。

## 詳細解説
- 背景：TCG_TPM2_HMACはカーネル側でTPMコマンドを暗号化し、HMACで改ざん検出する仕組みを導入する。各セッション鍵はEK（Endorsement Key）で鍵カプセル化し、Null Primary Key（起動ごとに変わるP-256 ECDHキー）を使う点が特徴。
- 問題の核心：カーネルはNull Primary KeyのNameを/sys/class/tpm/tpm0/null_nameに置き、後でユーザ空間がEKで検証すると信頼している。つまり「カーネルがユーザ空間を測定する」という責務の下で、ユーザ空間に検証を委ねることで信頼の方向が逆転している。
- 攻撃シナリオ（能動的インターポーザ）：
  1. ユーザ空間の検証コンポーネント（Component X）を差し替える／乗っ取る。  
  2. 偽のNull Primary Keyを用意して、TPMの応答を偽装する。  
  3. TPM2_PCR_Extendの送信値を差し替え、悪意あるコードを正しいコードとして測定させる。  
  4. 結果として、シークレットのアンシール等を不正に許してしまう。  
- 帰結：暗号を使って通信を保護しても、鍵の発行・検証や誰が何を信じるか（チェーン・オブ・トラスト）を正しく運用できていなければ、暗号は「装飾」に過ぎない。実際、機能はオーバーヘッドが大きく（頻繁なセッション鍵生成＝非対称処理）、2025年8月以降はデフォルトで無効に戻された。

## 実践ポイント
- 自分の環境でTCG_TPM2_HMACが有効か確認する（カーネル設定と/sys/class/tpm/*）。有効化のメリットとリスクを評価する。
- Null Primary Keyの取り扱いを信頼できるワークフローに組み込む：カーネル起動直後にユーザ空間任せで検証するのではなく、起動チェーン全体で「誰がいつどの鍵を検証するか」を明確化する。
- 物理アクセス・BMC経路を考慮した脅威モデルを作る：日本のデータセンタやオンプレ機器ではBMCや保守端末が現実的攻撃経路になり得る。物理隔離や管理プレーンの強化を検討する。
- 完全な解決策としてSoC内蔵のルート・オブ・トラストを検討する：CaliptraのようにCPU/SoCに統合された信頼基盤は、外付けTPMバスを介したインターセプションの問題を根本的に減らせる。ディスクリートTPMと組み合わせる運用も選択肢。
- 運用上の教訓をチームに共有する：暗号は万能ではなく「鍵管理と信頼の設計」がすべて。設計を説明できなければユーザや経営層に誤った安心感を与えてしまう。

短く言えば、TPM周りの「暗号で守る」設計を盲信せず、キー配布・検証フローと物理攻撃面を含む脅威モデルをまず固めることが最優先です。
