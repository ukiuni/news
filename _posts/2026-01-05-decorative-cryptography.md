---
  layout: post
  title: "Decorative Cryptography - 装飾的暗号学"
  date: 2026-01-05T10:22:43.048Z
  categories: [tech, world-news]
  tags: [tech-news, japan]
  source_url: "https://dlp.rip/decorative-cryptography"
  source_title: "Decorative Cryptography | Chris Fenner’s Personal Blog"
  source_id: 1398160742
  excerpt: "TPMの見た目だけの暗号化がバス改ざんで破られる危険を実例で解説"
---

# Decorative Cryptography - 装飾的暗号学
魅せかけの暗号に騙されるな：TPMの「安全そう」に潜む落とし穴

## 要約
LinuxのTCG_TPM2_HMAC機能はTPMとの通信を暗号化／HMACで保護しようとするが、鍵管理と信頼の連鎖を逆転させてしまい、能動的な物理インターセプタ（バス改ざん者）には簡単に破られる可能性がある、という警告。

## この記事を読むべき理由
TPMや測定ブートを使ったディスク暗号化／リモート認証は日本のオンプレ／クラウド混在環境やサーバ製品、OEM・BMCの供給連鎖で広く使われている。見た目に「暗号で守られている」機能が実際には攻撃に脆弱、あるいは誤った安心感を与えるケースを理解しておかないと、設計・運用で致命的な盲点を作りかねません。

## 詳細解説
- 問題の機能: TCG_TPM2_HMAC  
  カーネル（drivers/char/tpm/sessions.c）に実装されたオプションで、TPMコマンドの入力／出力を暗号化し、HMACで改ざん検知を行う。毎回セッション鍵をTPM内の「Null Primary Key」（ブートごとに変わるP-256 ECDHキー）で鍵封入（key-encapsulate）するため、高コスト（非対称処理多数）だが「より安全そう」に見える。

- 攻撃モデル: 受動（snooper）と能動（interposer）  
  受動はバスを傍受して情報を得るのみ。能動は読み書き両方を行い、測定値の差替えや秘密鍵の取り出しを狙う。測定ブートやTPMで「測定値を改ざんして正当と偽る」「TPMからアンシールされる秘密を入手する」ことが主要な狙い。

- 欠陥の核心: 信頼の逆転（chain-of-trust inversion）  
  カーネルはNull Primary KeyのName（ハッシュ）を /sys/class/tpm/tpm0/null_name に置き、後でユーザ空間がEK（Endorsement Key）でその鍵を証明すると期待している。だが、能動インターセプタはユーザ空間を差替えたり、TPM応答を偽装して任意のNullキーを作らせ、カーネルが測定する「ユーザ空間のハッシュ」を好きに書き換えられる。要するに、カーネルがユーザ空間を測る役目を負っているのに、そのユーザ空間側の整合性チェックを外部（後で）に委ねており、信頼の方向が逆になっている。

- 結果: 「暗号」が鍵管理問題に置き換わっているだけ  
  適用暗号は鍵を如何に管理・検証するかを解決しない限り「飾り」に過ぎず、誤った安心感を与える危険がある。実際、TCG_TPM2_HMACは負荷も高く、2025年8月のカーネル6.18でデフォルトオフに戻された。

- 現実的な対策例（著者の指摘）  
  本質的には物理的な能動攻撃を防ぐにはCPU内蔵の統合Root-of-Trustが必要（例: Caliptra, TCG DICE）。また、EKベースのセッション鍵を正しく検証する仕組みをブート初期に組み込むことが重要。

## 実践ポイント
- 自分の環境でTCG_TPM2_HMACが有効か確認する（カーネル設定／ディストリ確認）。負荷とリスクを考慮して無効化を検討する。
- /sys/class/tpm/tpm0/null_name の扱いを鵜呑みにしない。Null Primary KeyのNameはEKで早期に検証（ファームウェアやTPMの証明）する運用を設計する。
- 測定ブートの設計では「誰が誰を検証するか（X checks Y against Z）」を明確化する。カーネルがユーザ空間を測るなら、そのユーザ空間の整合性検証はカーネル側か、ブート直後の信頼できるエンティティで行う。
- 物理アクセスやBMC経由のバス操作が現実の脅威である環境（データセンタ、エッジ機器、OEMデバイス）では、TPMバスの物理的保護やCPU内蔵RoT（例: Caliptra / DICE）を優先検討する。
- 暗号を導入する際は「鍵管理のフロー」を設計書に明記し、第三者監査や攻撃シナリオで検証する。さもないと装飾的暗号になる。

短い結論: 暗号は万能ではない。設計時に「鍵と信頼の流れ」を厳密に定義し、物理的な脅威モデルを無視しないことが最優先です。
