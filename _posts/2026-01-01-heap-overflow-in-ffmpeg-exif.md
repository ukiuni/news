---
  layout: post
  title: "Heap Overflow in FFmpeg EXIF - FFmpeg EXIFのヒープオーバーフロー"
  date: 2026-01-01T16:58:09.676Z
  categories: [tech, world-news]
  tags: [tech-news, japan]
  source_url: "https://bugs.pwno.io/0014"
  source_title: "Heap-buffer-overflow in EXIF writer for extra IFD tags | Pwno"
  source_id: 46454854
  excerpt: "FFmpegのEXIF処理で4バイトのヒープオーバーフローが見つかり、画像でクラッシュや悪用の危険"
  ---

# Heap Overflow in FFmpeg EXIF - FFmpeg EXIFのヒープオーバーフロー
あなたの写真でクラッシュする？FFmpegのEXIF処理に潜む“4バイト”の落とし穴

## 要約
FFmpegのEXIFパーサで、追加IFD（Image File Directory）処理の不整合により4バイトのヒープバッファオーバーフローが発見された。PNG/JPEG/WEBP/AVIF等、広く使われるフォーマットに影響する短く深いバグ解析だ。

## この記事を読むべき理由
FFmpegはメディア処理の基盤ライブラリであり、日本のメディア系サービス、放送・映像制作ツール、モバイルアプリなど幅広く採用されている。EXIFは写真の撮影情報や位置情報を含むため、画像を扱うシステムの安全性・プライバシーに直結する。脆弱性は悪意ある画像でのクラッシュや任意コード実行につながる可能性があるため、開発者・運用者は仕組みと対策を押さえておくべきだ。

## 詳細解説
- 流れの要点
  - 画像デコーダ（例: libavcodec/pngdec.c）がファイル内のEXIFチャンクをバッファに読み込み、ff_decode_exif_attach_buffer()でav_exif_parse_buffer()に渡す。
  - av_exif_parse_buffer()はバイト列を解析してAVExifMetadataに変換する。主IFD（IFD0）を読み、必要なら追加IFD（extra IFD）を順次読み出す。FFmpegは内部で予約したタグ範囲（0xFFFC〜0xFFED）を「追加IFD格納用の合成タグ」として利用する。
- 問題の核心
  - exif_get_ifd_size()は、これらの“追加IFD”を最終的にメインIFDから剥がして別領域に書き出す前提で、サイズ計算時に追加IFDのディレクトリスロット分（12バイト）をゼロ扱いにし、全体バッファを小さめに確保する。
  - 一方で、av_exif_write()側は0xFFFCから順に「剥がす（peel）」処理を行い、最初に見つからないタグで処理を止める。ここでパーサ段階で合成タグをメインIFDに不連続に“偽装”して格納できると、peelが途中で止まり、exif_get_ifd_size()の想定どおりにスロットが省かれているにもかかわらず実際には残ったエントリが存在する状態になり得る。
  - exif_write_ifd()がディレクトリと実データを書き込む際、小さなデータ（例えばSHORTなど）を「インラインで書く」処理があり、パディングを消すために4バイトを書き込む命令（AV_WN32）を行うが、バッファ末尾近くでこの4バイト書き込みが行われると確実にバッファを越えて隣のヒープ領域に上書きする。結果としてASanが報告する4バイトのheap-buffer-overflowが発生する。
- 影響範囲と再現
  - 解析ではPNG/JPEG/WEBP/AVIF/JXL/TIFFなど多数のフォーマットで再現が確認されている。標準ビルドのffmpegで単に「ffmpeg -i <file>」とするだけでトリガー可能なケースがある。
- 対応
  - 発見から短期間で修正パッチが提供され、メンテナは修正をマージ済み（公開タイムラインは年末の報告に基づく）。

## 実践ポイント
- すぐやること
  - FFmpegを使う環境は、配布やパッケージで入手可能な最新のセキュリティ修正済ビルドへ更新する。
  - 外部から受け取る画像は信頼せず、受信前にEXIFを除去する（例: exiftool等で -all= を使うか、FFmpegで再エンコード時にメタデータを削除する）。
- 開発者向け対策
  - 生のEXIFをそのまま内部構造に流す前にパーサの堅牢性チェックを追加する（追加IFDタグの位置・連続性検証、サイズ算出と実際のエントリの整合性検査）。
  - サニタイザ（ASan）、内部Fuzzingを導入してバイナリIO周りの脆弱性を早期に発見する。
  - ライブラリを統合する場合は、アップストリームのパッチを取り込み、社内バージョン差分を最小にして追従を容易にする。
- 運用上の注意
  - メディア処理パイプラインやユーザー投稿機能を持つサービスは、不正なファイルでクラッシュやDoSされないか監視を強化する。
  - サードパーティのプラグインやデバイス（STB、放送機材、スマホ向けネイティブライブラリ）もFFmpegのバージョン依存になるため、ベンダー提供の更新情報を確認する。

