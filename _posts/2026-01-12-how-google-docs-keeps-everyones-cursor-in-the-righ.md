---
layout: post
title: "How Google Docs keeps everyone’s cursor in the right place - Google ドキュメントはどうやって全員のカーソル位置を正しく保つのか"
date: 2026-01-12T14:03:23.129Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://www.hexplain.space/blog/dSxYGjAarHYYVqH51F1O"
source_title: "Hexplain | Write. Discuss. Get Hired By Your Work"
source_id: 428665327
excerpt: "Google DocsがOTで同時編集中の全員のカーソル位置を確実に同期する仕組み解説"
image: "https://hexplian.space/og-image.png"
---

# How Google Docs keeps everyone’s cursor in the right place - Google ドキュメントはどうやって全員のカーソル位置を正しく保つのか

同時編集でも「カーソルが迷子にならない」理由を、エンジニア目線でやさしく解説

## 要約
Google Docs は、ローカルで即時に編集を反映しつつサーバーで操作順序を決め、操作（insert/delete）と同じ変換ルールで各ユーザーのカーソル位置を自動的に更新することで、全員の表示を一致させています。

## この記事を読むべき理由
リモートワークやオンライン共同編集が当たり前になった今、同時編集の根幹となる同期アルゴリズム（OT/CRDT）や「カーソル位置の扱い」がどのように実装されているかを理解すると、自社ツール設計やバグ対応、パフォーマンス改善に直結する知見が得られます。特に日本語の文字列や絵文字混在の文書では注意点が増えるため必読です。

## 詳細解説
- クライアントの楽観的な編集とサーバー調整  
  ユーザーは入力を即時反映（楽観的更新）します。操作はネットワークでサーバーに送られ、サーバーが正しい並び（全体順序）を決めて各クライアントに配信します。クライアントはサーバーから来た「他人の操作」や自分の操作の確定応答を受け、必要なら未確定のローカル操作に対して変換（transform）を行います。

- Operational Transformation (OT) の役割  
  OT は「同時に発生した操作を互いに変換して整合する」アルゴリズム群の総称です。挿入や削除の位置が競合するとき、OT は各操作を変換して最終的に全クライアントが同じテキスト状態に収束するようにします。Google Docs は歴史的に OT 系のアプローチを採用してきたことが公開情報として知られています。

- カーソルは「位置の情報」も操作として扱う  
  カーソル（選択範囲）はゼロ長または範囲の位置情報で、挿入/削除が発生したときに同じ変換ロジックで更新されます。例えば誰かが自分のカーソルの前に文字を挿入すればカーソル位置は後ろにシフトし、カーソル内が削除されたら境界に合わせてクリップされます。これをカーソル専用の transform ルールで扱うことで、全員の表示が一貫します。

- 実装上の要点と課題  
  - 未確定操作（pending ops）を持つクライアントは、サーバー応答に対して自分の未送信操作を変換する必要がある。  
  - 範囲選択や複数カーソル、リッチテキスト（属性付き文字列）は単純なインデックス変換より複雑になる。  
  - マルチバイト文字やEmoji、結合文字列（グラフェム）に対しては「コード単位」ではなく「ユーザーが見る文字単位」で位置を扱わないと文字を分断してしまうリスクがある。  
  - CRDT（競合しないレプリカデータ型）は別アプローチで、OT よりも衝突解決が自動化されるが、識別子の肥大化やパフォーマンス調整が必要になる。

## 実践ポイント
- 小さな共同編集機能を作るならまずは OT の基本（insert/delete の transform）を実装してみる。サーバーでシーケンスを付けてクライアントは楽観更新／再変換を行う構成が学習コスト低め。  
- カーソルも操作と同様に変換対象として扱う（範囲選択は開始/終了それぞれ変換）。  
- 日本語や絵文字対応では「グラフェム単位」でのインデックス管理を必ず検討する（UTF-16/UTF-8 のバイト単位での計算は危険）。  
- プレゼンス（カーソル位置）送信は高頻度だと帯域を圧迫するため、デバウンス／スロットリングや差分のみ送る工夫をする。  
- テストは意図的に同時操作やネットワーク遅延・再接続をシミュレートして行う。実運用での角ケース（範囲内削除、複数ユーザーの連続挿入など）をカバーすること。

この記事を理解すれば、Google Docs 的な「みんなのカーソルがいつも正しい」体験を自分たちのプロダクトに応用する基礎が身につきます。
