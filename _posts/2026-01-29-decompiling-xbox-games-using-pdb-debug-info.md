---
layout: post
title: "Decompiling Xbox games using PDB debug info - XboxゲームをPDBデバッグ情報で逆コンパイルする"
date: 2026-01-29T08:18:13.073Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://i686.me/blog/csplit/"
source_title: "i686.me | Decompiling Xbox games using PDB debug info"
source_id: 46768845
excerpt: "PDBのsection contributionsでHaloをオブジェクト単位で復元しデバッグ付き起動"
---

# Decompiling Xbox games using PDB debug info - XboxゲームをPDBデバッグ情報で逆コンパイルする
PDBの“節（section contribution）”を使ってHalo（オリジナルXbox）を分解・復元した舞台裏

## 要約
PDBに記録された「section contributions」を直接使うことで、オブジェクト単位で正確にバイナリを分割・再構築し、x86向けのマッチング逆コンパイルを進めた話。結果としてデバッグ付きHaloが起動まで到達したが、まだ細部で修正が必要という経緯。

## この記事を読むべき理由
PDBに眠る情報はゲームやレガシーソフトの復元・解析で決定打になり得ます。日本のゲーム保全や組み込み／ネイティブ開発に関わるエンジニアが、より正確なバイナリ分割とマッチング逆コンパイルの実践的手法を知るべきだからです。

## 詳細解説
- マッチング逆コンパイルとは  
  バイナリを「元のオブジェクト単位」に戻し、オリジナルと同等のソース（バイト／命令レベルで一致）を目指す手法。従来は手作業やツールの推定に頼り境界が曖昧になりがちだった。

- PDBの有用性（section contributions）  
  Visual C++のリンカは、どの入力COFFセクションが実行ファイルのどのアドレスに入ったかをPDBの「section contributions」に書き残す。これにはアドレス、サイズ、フラグ、元のオブジェクト名、チェックサムなどが含まれ、分割（split）作業で「文字通りそのまま」オブジェクトを切り出せる決定的な証拠になる。型情報が無い（stripped PDBでも有効）場合でも非常に強力。

- 実装上の工夫  
  著者はPDBを直接読んでsection contributionsを元にオブジェクトを生成する独自の「splitter」を作成。古いVC++デバッグ形式（VC++ 2.00 / VC++7 beta2相当）を扱うためにRustのpdbクレートを改造して対応した。COMDATやプライベートシンボル名が無い場合はフラグや内容に基づく一時名付け（例: code_0041234）で対処。

- 制御フロー生成と相対リロケーション  
  絶対リロケーションは.relocで分かるが、相対jmp/callのターゲットは制御フロー解析で復元する必要がある。自己完結させるため著者はCFG生成を使って相対リロケーションを特定した。

- SafeSEH（構造化例外）問題  
  __try/__catchでコンパイラが生成するハンドラは直接ジャンプされないためCFGだけでは発見できないことがあり、多数のハンドラを手動修正したと報告している。

- コンパイラ最適化に伴う「負のリロケーション」  
  あるテーブル参照で「引き算を最適化してリロケーションがテーブルの前に指す」ケースがあり、単純に「ターゲットより直前のシンボルを割当てる」戦略だと誤ったリロケーションになりうる。著者は手作業で修正して起動を進めた。

- 結果と残課題  
  起動は達成しメインメニューまで到達したが、マップ切替やストリーミングスレッドで未解決のクラッシュが残る。将来的にはCFGやマッチングリンクでこれらが自然に解決される見込み。

## 実践ポイント
- PDBを「シンボルマップ」ではなく「section contributionsの真実の記録」として扱う。  
- Stripped PDBでもsection contributionsは有用：型情報なしでも物理的なオブジェクト分割が可能。  
- 相対リロケーションはCFG生成で拾う（IDA等への依存を減らすなら自前実装を検討）。  
- SafeSEHや例外ハンドラはCFGだけでは抜けることがあるので特別扱いを用意する。  
- 「負のリロケーション（コンパイラ最適化）」に注意し、単純なヒューリスティックで誤りを生まないよう手動確認や上位レベルの照合を行う。  
- 参考リポジトリや進捗は decomp.dev や該当GitHubを参照して実例コードやツール群を活用する。

（参考）元記事: "Decompiling Xbox games using PDB debug info" — オリジナルの解析リポジトリや進捗情報は元記事／リポジトリを参照してください。
