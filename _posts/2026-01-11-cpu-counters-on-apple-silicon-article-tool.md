---
layout: post
title: "CPU Counters on Apple Silicon: article + tool - Apple SiliconのCPUカウンタ：記事とツール"
date: 2026-01-11T04:48:35.299Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://blog.bugsiki.dev/posts/apple-pmu/"
source_title: "PMU Counters on Apple Silicon | Bugsik"
source_id: 46525236
excerpt: "Instrumentsでの失敗を招く、PMUカウンタのマスクと順序依存を解説"
---

# CPU Counters on Apple Silicon: article + tool - Apple SiliconのCPUカウンタ：記事とツール
知られざるApple Siliconの「10個ルール」と順序バグを解き明かす — PMUカウンタの全取得ツールから学ぶ性能プロファイリングの落とし穴

## 要約
Apple Silicon（M1/M2系）のPMU（Performance Monitoring Unit）カウンタを全取得するツールを作る過程で、Apple Instrumentsの「最大10カウンタ」制限、固定カウンタの存在、カウンタ同士の互換性がマスクビットで決まっていること、そして「登録順序が結果を左右する」ことが明らかになった。

## この記事を読むべき理由
Mac（特にM1/M2以降）で性能改善やボトルネック解析をする日本の開発者・運用担当者にとって、Instrumentsだけに頼ると見落とす落とし穴が多数ある。正しいカウンタ選び・並べ方・検証方法を知ることで、診断の精度が大きく向上する。

## 詳細解説
- PMUカウンタとは  
  PMUはCPU内部の微視的イベント（命令数、サイクル、キャッシュミス、分岐ミスなど）をハードウェアで数える仕組み。固定（Cycles/Instructionsなど）とプログラム可能なカウンタがあり、組み合わせで観察対象を決める。

- なぜ調査が必要だったか  
  既存のツールは一部のプリセットに対応する程度で、Apple独自の非公開API（kperf）を使う実装や互換性の詳細は公開情報が乏しい。実験的に全カウンタ取得を試みた結果、Instrumentsで遭遇するエラーの原因が浮かび上がった。

- kperfとkpep_dbの発見  
  kperf（非公開API）から得られるカウンタ情報には各イベントに対する「mask」フィールドがあり、このビットマスクが互換性と配置可能数を決定している。実機で取得した例では、mask幅は10ビットで、これが「最大10カウンタ」の根拠になる。

- マスクによるルール（要点）
  - 固定カウンタはマスクがユニークで常に他と共存可能。例：Cycles = `0b0000000001`、Instructions = `0b0000000010`。
  - 同じマスクを持つカウンタ群は「同じスロット」を占有するため、個数に制約が生じる。これが互換性の原因（グループMやグループGとして観察された）。
  - カウンタを追加する順序が挙動に影響する：ある順序だと追加に失敗するが、並べ替えると成功するケースがある（Instruments上でも同様）。

- 実験と組合せ爆発  
  実機で55〜60個程度のカウンタを対象に、組合せを試行した結果、サイズ7の組合せだけで膨大な失敗ケースが観測された。組合せ数は例えば
  $$\binom{55}{7} = 202{,}927{,}725$$
  と非常に大きく、実験はすぐに計算的に難しくなる。

- 具体的な注意例（再現手順）  
  Instrumentsで以下の順に追加すると最後がエラーになるが、末尾の2つを入れ替えると成功する：
  1. L1D_TLB_ACCESS  
  2. L1D_TLB_MISS  
  3. L1D_CACHE_MISS_ST  
  4. L1D_CACHE_MISS_LD  
  5. LD_UNIT_UOP  
  6. ST_UNIT_UOP  
  7. INST_LDST  ← エラーになる場合あり  
  6'と7'を入れ替えると成功する例がある（順序依存性の典型）。

## 実践ポイント
- Instrumentsで「追加できない」エラーが出たら、まずはカウンタの順序を変えてみる。多くは順序変更で解決する。  
- 最大同時カウンタ数は10（mask幅に依存）。固定カウンタ（Cycles/Instructions）は例外的に衝突しにくい。  
- より多く・詳細に調べたい場合はkperfベースのツール（sudo権限が必要になることが多い）を使い、kpep_dbのmaskフィールドを確認してから組合せを決めると安全。  
- AppleのCPU最適化ガイド（Apple Developerアカウントが必要）にあるイベントリストと実機の差異を意識すること。表示されるカウンタ一覧と実際の互換性／マスクは一致しない場合がある。  
- CIやビルドマシンでM1/M2を使う組織では、プロファイリング手順書に「カウンタ順序の確認」「固定カウンタを必ず含める」「kperfでの検査」を明記すると再現性が上がる。

短く言えば、Apple SiliconのPMUは「単に選べば動く」ものではなく、マスクと順序という低レイヤ条件を理解して扱う必要がある。この記事で紹介された調査手法とツールは、その理解を短縮してくれる出発点になる。
