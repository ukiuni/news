---
  layout: post
  title: "XMPP and metadata - XMPPとメタデータ"
  date: 2026-01-07T17:32:16.710Z
  categories: [tech, world-news]
  tags: [tech-news, japan]
  source_url: "https://blog.mathieui.net/xmpp-and-metadata.html"
  source_title: "XMPP and metadata"
  source_id: 1668204531
  excerpt: "本文暗号化でも送信元や参加情報が判別されるXMPPの脆弱と対策"
  ---

# XMPP and metadata - XMPPとメタデータ
あなたのチャットは「本文だけ」守られているか？XMPPのメタデータが暴く通信の実像と現実的な対策

## 要約
XMPPではメッセージ本文を暗号化していても、送信元・送信先・タイミング・ルーム参加情報などのメタデータはサーバーや経路に残りやすく、攻撃者や運営者によって観察・相関される危険がある。対策はサーバー選び、自端末での保護、暗号化方式の理解とクライアント設定の見直しに集約される。

## この記事を読むべき理由
国内ではLINEやSlackなど中央集権型サービスが主流だが、XMPPは分散（フェデレーション）で柔軟性が高い。企業システムやプライベートチャット、オープンなコミュニティでXMPP利用を考える日本の技術者にとって、通信の「中身」が守られてもメタデータで個人や活動が特定されるリスクは見落とせない。設計判断・運用ポリシー・クライアント選定に直接影響する知識を得られる。

## 詳細解説
- メタデータの定義  
  メタデータは「データについてのデータ」。チャットでは本文がデータで、送信者・受信者・タイムスタンプ・ペイロードサイズ・オンライン状況などがメタデータに相当する。これらはしばしば暗号化されずに残る。

- XMPPの基本構造と観察点  
  XMPPは拡張可能なフェデレーテッドなプロトコルで、クライアント→サーバー、サーバー→サーバーのやりとりがある点が重要。自分のサーバーは自分の通信を外部に送る唯一の出口であり、クライアントが送るXMLは必ず自サーバー経由になる。つまり「信頼できるサーバー運営」が第一の防御。

- メタデータに対する脅威モデル（要点）
  1. クライアント側ネットワークの攻撃者：パケットのタイミング・サイズ、HTTPベースのアップロードやSTUN/TURN問い合わせなどで一部メタデータを取得。P2Pやメディア経路はTLS外の別経路に出ることがある。  
  2. サーバー経路上の攻撃者（サーバー間ネットワーク）：クライアントと各相手サーバーへの接続を同時に観察できれば相関で送受信先が特定可能。利用者が少ない小サーバーは特に危険。  
  3. サーバーの完全侵害（現在／将来のバックアップ含む）：オンディスクのアカウント情報、ロスター（連絡先）、ブックマーク、vCard（プロフィール・アバター）、チャットアーカイブ、ルーム構成やメンバー情報が露出する。

- グループチャットの特殊性  
  部屋(room)はホストするサーバーが明示され、非匿名ルームでは参加者のフルアドレスが露出。半匿名ルームではニックネームしか見えないが、ホストや各参加者のサーバーは発言者の実在情報にアクセス可能。

- メディア経路（STUN/TURN/HTTP Upload）の問題  
  NAT回避で使うSTUNは外部アドレスを露出する。TURNは中継サーバーへ暗号化ストリームが行くため、その時点で中継側にメタデータが残る。HTTP UploadなどはXMPPのTLS外で別サービスにリクエストが飛ぶ場合がある。

- E2EE（OMEMO等）の限界  
  OMEMOは広く使われるが、従来版はメッセージ本文（body）だけ暗号化する実装が多く、スタンザ全体やメタタグを保護しない。最近の拡張で「Stanza Content Encryption」が提案されているが普及は段階的。

- 対策案（設計・運用の余地）
  - ネットワークメタデータ対策：パディング、ランダム遅延、スタンザのバッチ化や“ゴミ”スタンザ挿入など。ただし遅延や帯域のコスト、実装の複雑さがある。  
  - ロスター／ブックマークのローカル保存：端末で暗号化・署名して同期する仕組みへ移行すればサーバーに平文で残らない。  
  - グループチャット運用：プライバシー重視なら参加するルームのホストや公開設定を確認し、必要なら非永続的ルームや匿名ニックネームを利用。  
  - 代替アーキテクチャ：ローカルネットワークのみのXEP-0174や将来のRELOAD、クライアント間でTLSを張るXTLSなどはメタデータの可視点を変えるが、それぞれ利便性・暗号化・機能の制約がある。

## 実践ポイント
- 信頼できるサーバーを選ぶ／自ホストを検討する（providers.xmpp.netのような信頼できる一覧を参照）。  
- クライアント設定でOM EMO（最新実装）を有効にし、可能ならStanza Content Encryptionに対応するクライアントを使う。  
- 不要なプレゼンス通知や自動的なルーム再参加、HTTP Uploadの自動利用をオフにする。  
- 重要なグループはホスト先を決めて、非永続部屋やニックネーム利用で実運用を工夫する。  
- メディア通話やファイル転送時はSTUN/TURN経路を意識し、機密性が高い通信ではVPN/Torなどの別レイヤーも検討する（実運用での副作用を確認）。  
- 運用側（サーバー管理者）なら：ロスターやブックマークの暗号化保存、ログ保管ポリシーの最小化、遅延導入・スタンザバッチ化の評価を行う。

XMPPは自由度と拡張性が魅力だが、それゆえに設計次第でメタデータが漏れやすい。本文だけで安心せず、通信経路・サーバー運用・クライアント設定まで含めた総合的なプライバシー設計を検討することが重要である。
