---
layout: post
title: "SSH has no Host header - SSHにはHostヘッダがない"
date: 2026-01-22T21:48:07.027Z
categories: [tech, world-news]
tags: [tech-news, japan]
source_url: "https://blog.exe.dev/ssh-host-header"
source_title: "SSH has no Host header - exe.dev blog"
source_id: 1680585032
excerpt: "SSHにHostヘッダはなく、exe.devはIPを所有者に紐付けてVM振り分けを実現した"
---

# SSH has no Host header - SSHにはHostヘッダがない
同じドメインで複数VMのSSH接続をどう振り分けたか？exe.devが編み出した「IPを所有者に紐づける」トリック

## 要約
SSHにはHTTPのHostヘッダのように到達先ドメインを教える仕組みがなく、同一IPv4アドレスを複数VMで共有するとSSH接続を正しいVMに振り分けられない。exe.devは「IPプールを用意し、IPをユーザー（所有者）に相対的に割り当てる」方式でこれを解決した。

## この記事を読むべき理由
IPv4アドレス枯渇やコスト制約で複数VMを同一IPで運用したいサービスは増えています。日本のスタートアップやインフラ担当者にとって、SSHの仕様上の限界と現実的な回避策は実運用に直結する知識です。

## 詳細解説
- 問題点：HTTPはリクエスト内のHostヘッダで「どのドメイン宛か」を伝えられるため、1つのIPで複数サイトをホスティングできる（仮想ホスト）。SSHにはそのようなヘッダがないため、同一IPを共有するVM群に対し「どのVMに転送すべきか」を接続時に判別できない。
- exe.devのアプローチ：
  - 公開IPv4のプールを持ち、各VMに「所有者に対して一意なIP」を割り当てる（例：s003.exe.xyz が示すAレコードのIPは多くのVMで使われるが、特定ユーザーにとってはそのIPは唯一のVMを指す）。
  - SSH接続時にクライアントが提示する公開鍵（＝誰が接続しようとしているか）と、接続先の受信ローカルIPを組み合わせた {user, IP} のタプルでどのVMかを一意に決定する。
- 実装上の課題：
  - VM作成時に所有者に応じたIP割当ロジックを管理する専用ソフトが必要。
  - プロキシ側で「接続がどのローカルIPに来たか」を正確に知る必要があり、裸の専用サーバ（ベアメタル）では簡単だが、クラウドでのNAT越えやVPC構成だと難易度が上がる。
- 限界：一般的な汎用ソリューションとして万人に勧められるわけではなく、運用コストと設計の複雑さを伴う点に注意。

```bash
# 例: dig出力の簡易イメージ
$ dig undefined-behavior.exe.xyz
;; ANSWER SECTION:
undefined-behavior.exe.xyz. 230 IN CNAME s003.exe.xyz.
s003.exe.xyz.             230 IN A  16.145.102.7
```

## 実践ポイント
- 小規模サービスなら、単純にユーザーごとに固有IPを割り振るか、SSHジャンプホスト（bastion）で中継するのが現実的。
- 複数ユーザーでIPを共有する場合、exe.dev方式のように「認証情報（公開鍵）＋受信IP」で結び付ける設計は有効だが、専用の管理層とネットワーク知見が必要。
- クラウド環境ではNATやロードバランサーの挙動を確認し、受信先ローカルIPが正しく得られるかを検証すること。
- 代替案としては、ポート分け・サブドメインごとの別ポート、あるいはSSHをTLS経由（HTTPS/WSトンネリング）で運ぶ方法も検討する。
